<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nutri-Track SÃ¨che 10 Sem - Hocine</title>
    <style>
        * {margin: 0; padding: 0; box-sizing: border-box;}
        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 15px; color: #333;}
        .container {max-width: 950px; margin: 0 auto; background: white; border-radius: 20px; padding: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);}
        h1 {text-align: center; color: #667eea; margin-bottom: 5px; font-size: 26px;}
        .version-badge {text-align: center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; display: inline-block; margin: 5px;}
        .gas-badge {background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);}
        .season-badge {background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);}
        .cholesterol-badge {background: linear-gradient(135deg, #fab005 0%, #f59f00 100%);}
        .header-info {text-align: center; color: #666; margin-bottom: 15px; font-size: 13px;}
        .timeline-container {background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 20px; border-radius: 15px; margin-bottom: 20px; overflow-x: auto;}
        .timeline {display: flex; justify-content: space-between; align-items: center; position: relative; max-width: 100%;}
        .timeline-line {position: absolute; top: 50%; left: 5%; right: 5%; height: 4px; background: #dee2e6; z-index: 0; transform: translateY(-50%);}
        .timeline-progress {position: absolute; top: 50%; left: 5%; height: 4px; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); z-index: 1; transform: translateY(-50%); transition: width 0.5s;}
        .timeline-item {position: relative; z-index: 2; text-align: center; cursor: pointer; flex: 1; padding: 5px;}
        .timeline-dot {width: 40px; height: 40px; border-radius: 50%; background: white; border: 4px solid #dee2e6; margin: 0 auto 5px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 12px; transition: all 0.3s;}
        .timeline-item.active .timeline-dot {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea; transform: scale(1.2);}
        .timeline-item.completed .timeline-dot {background: #51cf66; border-color: #51cf66; color: white;}
        .timeline-item.future .timeline-dot {background: #f8f9fa; border-color: #dee2e6;}
        .timeline-label {font-size: 11px; font-weight: bold; color: #666;}
        .timeline-phase {font-size: 9px; color: #999; margin-top: 2px;}
        .day-tracker {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; text-align: center;}
        .day-display {font-size: 28px; font-weight: bold; margin: 10px 0;}
        .day-controls {display: flex; gap: 8px; justify-content: center; margin-top: 10px; flex-wrap: wrap;}
        .auto-save-indicator {position: fixed; top: 20px; right: 20px; background: #51cf66; color: white; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: bold; opacity: 0; transition: opacity 0.3s; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.2);}
        .auto-save-indicator.show {opacity: 1;}
        .tabs {display: grid; grid-template-columns: repeat(auto-fit, minmax(90px, 1fr)); gap: 8px; margin-bottom: 20px;}
        .tab {padding: 12px 8px; background: #f0f0f0; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s; font-size: 12px;}
        .tab.active {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);}
        .tab-content {display: none;}
        .tab-content.active {display: block; animation: fadeIn 0.4s;}
        @keyframes fadeIn {from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);}}
        @keyframes slideIn {from {opacity: 0; transform: translateX(100px);} to {opacity: 1; transform: translateX(0);}}
        @keyframes slideOut {from {opacity: 1; transform: translateX(0);} to {opacity: 0; transform: translateX(100px);}}
        @keyframes modalPulse {0% {transform: scale(0.9); opacity: 0;} 50% {transform: scale(1.02);} 100% {transform: scale(1); opacity: 1;}}
        .conseil-popup {position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 20px; box-shadow: 0 15px 50px rgba(0,0,0,0.3); z-index: 5000; max-width: 500px; width: 90%; animation: modalPulse 0.5s; border-left: 6px solid #667eea;}
        .conseil-popup-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4999;}
        .nutrition-section {background: #f0f4ff; border-radius: 15px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #667eea;}
        .nutrition-section h3 {color: #667eea; margin-bottom: 12px; font-size: 18px;}
        .meal {background: white; padding: 12px; margin: 10px 0; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .meal-details {display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 6px; margin: 8px 0; font-size: 12px;}
        .detail-item {background: #f0f0f0; padding: 5px 8px; border-radius: 6px;}
        .detail-label {font-weight: bold; color: #667eea;}
        .meal-foods {background: #f9fafb; border-radius: 8px; padding: 10px; margin: 10px 0; font-size: 13px; line-height: 1.6;}
        .meal-foods ul {margin-left: 20px;}
        .season-tag {background: #fff9e6; color: #ff6b00; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 5px;}
        .cholesterol-tag {background: #fff3bf; color: #f59f00; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-left: 5px;}
        /* ğŸ†• Styles pour supplÃ©ments et ajouts anti-inflammatoires */
        .supplements-box {background: #e8f5e9; border-left: 4px solid #51cf66; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;}
        .anti-inflam-box {background: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;}
        .gas-tip {background: #e8f5e9; border-left: 4px solid #51cf66; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;}
        .hydration-note {background: #e3f2fd; border-left: 4px solid #2196f3; padding: 10px; margin: 10px 0; border-radius: 6px; font-size: 12px;}
        .validation-checkbox {display: flex; align-items: center; gap: 10px; background: #e8f5e9; padding: 10px; border-radius: 8px; margin-top: 10px; cursor: pointer;}
        .validation-checkbox input {width: 20px; height: 20px; cursor: pointer;}
        .validation-checkbox.validated {background: #c8e6c9;}
        .progress-card {background: white; padding: 15px; border-radius: 10px; margin: 10px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1);}
        .progress-bar-container {background: #e0e0e0; border-radius: 10px; height: 30px; margin: 10px 0; overflow: hidden;}
        .progress-bar {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 14px;}
        .macro-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; margin: 15px 0;}
        .macro-card {background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%); padding: 15px; border-radius: 10px; text-align: center;}
        .macro-card.calories {background: linear-gradient(135deg, #ffd93d 0%, #ff9800 100%); color: white;}
        .macro-card.proteines {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;}
        .macro-card.glucides {background: linear-gradient(135deg, #ffa500 0%, #ff6347 100%); color: white;}
        .macro-card.lipides {background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white;}
        .macro-card.hydration {background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%); color: white;}
        .macro-value {font-size: 28px; font-weight: bold; margin: 5px 0;}
        .macro-label {font-size: 11px; opacity: 0.9; text-transform: uppercase;}
        .week-card {background: white; border-radius: 15px; padding: 20px; margin: 15px 0; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 6px solid #667eea;}
        .week-card.agressive {border-left-color: #ff6b6b;}
        .week-card.deload {border-left-color: #ffc107;}
        .week-card.moderee {border-left-color: #51cf66;}
        .week-header {display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;}
        .week-title {font-size: 22px; font-weight: bold; color: #667eea;}
        .phase-badge {padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; color: white;}
        .phase-badge.agressive {background: linear-gradient(135deg, #ff6b6b 0%, #ff8787 100%);}
        .phase-badge.deload {background: linear-gradient(135deg, #ffc107 0%, #ffd54f 100%);}
        .phase-badge.moderee {background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%);}
        .stats-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; margin: 15px 0;}
        .stat-item {background: #f8f9fa; padding: 12px; border-radius: 8px; text-align: center;}
        .stat-value {font-size: 24px; font-weight: bold; color: #667eea; margin: 5px 0;}
        .stat-label {font-size: 11px; color: #666; text-transform: uppercase;}
        .chart-container {background: #f8f9fa; border-radius: 10px; padding: 20px; margin: 15px 0; min-height: 300px; position: relative;}
        .chart-svg {width: 100%; height: 250px;}
        .form-group {margin: 15px 0;}
        .form-label {display: block; font-weight: bold; color: #667eea; margin-bottom: 8px; font-size: 14px;}
        .form-input {width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; transition: border 0.3s;}
        .form-input:focus {border-color: #667eea; outline: none;}
        .form-row {display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px;}
        .alert-box {padding: 15px; border-radius: 10px; margin: 15px 0; font-size: 14px; border-left: 4px solid;}
        .alert-success {background: #e8f5e9; border-color: #51cf66; color: #2e7d32;}
        .alert-warning {background: #fff9e6; border-color: #ffc107; color: #f57c00;}
        .alert-danger {background: #ffebee; border-color: #ff6b6b; color: #c62828;}
        .alert-info {background: #e3f2fd; border-color: #2196f3; color: #1565c0;}
        .grignotage-section {background: #fff9e6; border-left: 5px solid #ffc107; padding: 15px; border-radius: 15px; margin: 15px 0;}
        .grignotage-item {background: white; padding: 10px; margin: 8px 0; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;}
        .btn {padding: 10px 16px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; transition: all 0.3s; font-size: 13px;}
        .btn-primary {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;}
        .btn-primary:hover {transform: scale(1.05); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);}
        .btn-secondary {background: rgba(255,255,255,0.2); color: white; border: 2px solid white;}
        .btn-danger {background: #ff6b6b; color: white;}
        .btn-success {background: #51cf66; color: white;}
        .modal {display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; justify-content: center; align-items: center; overflow-y: auto;}
        .modal.show {display: flex;}
        .modal-content {background: white; padding: 30px; border-radius: 20px; max-width: 500px; width: 90%; margin: 20px; animation: modalPop 0.3s; max-height: 90vh; overflow-y: auto;}
        @keyframes modalPop {from {transform: scale(0.8); opacity: 0;} to {transform: scale(1); opacity: 1;}}
        .modal-header {font-size: 22px; font-weight: bold; color: #667eea; margin-bottom: 15px; text-align: center;}
        .modal-body {margin: 15px 0;}
        .notes-area {width: 100%; min-height: 80px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 13px; margin-top: 10px;}
        .info-box {background: #e3f2fd; border-left: 4px solid #2196f3; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px;}
        .warning-box {background: #fff3cd; border-left: 4px solid #ffc107; padding: 12px; border-radius: 8px; margin: 10px 0; font-size: 13px;}
        .option-selector {background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 10px 0;}
        .option-btn {padding: 8px 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; margin: 4px; cursor: pointer; font-size: 12px; font-weight: bold; transition: all 0.3s;}
        .option-btn.active {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: #667eea;}
        @media (max-width: 600px) {
            .container {padding: 12px;}
            h1 {font-size: 22px;}
            .macro-grid, .stats-grid {grid-template-columns: repeat(2, 1fr); gap: 8px;}
            .macro-card {padding: 10px;}
            .macro-value {font-size: 18px;}
            .macro-label {font-size: 10px;}
            .timeline-item {padding: 2px;}
            .timeline-dot {width: 30px; height: 30px; font-size: 10px;}
            .timeline-label, .timeline-phase {font-size: 9px;}
        }
    </style>
</head>
<body>
    <div class="auto-save-indicator" id="auto-save-indicator">âœ… SauvegardÃ©</div>
    <div class="container">
        <h1>ğŸ”¥ PLAN SÃˆCHE 10 SEMAINES</h1>
        <div style="text-align: center;">
            <span class="version-badge">v5.0 SÃˆCHE â€¢ Hocine 44 ans</span>
            <span class="version-badge season-badge" id="season-badge">ğŸ‚ AUTOMNE</span>
        </div>
        <div class="header-info">93.4kg â€¢ 105cm taille â€¢ Objectif 88kg en 10 semaines â€¢ Phase de sÃ¨che maximale</div>
        
        <div class="timeline-container">
            <div style="text-align: center; margin-bottom: 15px; font-weight: bold; color: #667eea;">PROGRESSION 10 SEMAINES</div>
            <div class="timeline">
                <div class="timeline-line"></div>
                <div class="timeline-progress" id="timeline-progress" style="width: 0%"></div>
                <div class="timeline-item" onclick="afficherSemaine(1)">
                    <div class="timeline-dot">S1</div>
                    <div class="timeline-label">Semaine 1</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(2)">
                    <div class="timeline-dot">S2</div>
                    <div class="timeline-label">Semaine 2</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(3)">
                    <div class="timeline-dot">S3</div>
                    <div class="timeline-label">Semaine 3</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(4)">
                    <div class="timeline-dot">S4</div>
                    <div class="timeline-label">Semaine 4</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(5)">
                    <div class="timeline-dot">S5</div>
                    <div class="timeline-label">Semaine 5</div>
                    <div class="timeline-phase">Deload</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(6)">
                    <div class="timeline-dot">S6</div>
                    <div class="timeline-label">Semaine 6</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(7)">
                    <div class="timeline-dot">S7</div>
                    <div class="timeline-label">Semaine 7</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(8)">
                    <div class="timeline-dot">S8</div>
                    <div class="timeline-label">Semaine 8</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(9)">
                    <div class="timeline-dot">S9</div>
                    <div class="timeline-label">Semaine 9</div>
                    <div class="timeline-phase">SÃ¨che</div>
                </div>
                <div class="timeline-item" onclick="afficherSemaine(10)">
                    <div class="timeline-dot">S10</div>
                    <div class="timeline-label">Semaine 10</div>
                    <div class="timeline-phase">Finale</div>
                </div>
            </div>
        </div>

        <div class="day-tracker">
            <div style="font-size: 14px; margin-bottom: 5px;">ğŸ“… <span id="semaine-actuelle-label">SEMAINE 1</span></div>
            <div class="day-display" id="day-display">ğŸ‹ï¸ JOUR TRAINING</div>
            <div style="font-size: 11px; color: #666; margin: 5px 0; text-align: center;" id="auto-mode-indicator">ğŸ¤– Mode AUTO (Lun/Mer/Ven=Training)</div>
            <div class="day-controls">
                <button class="btn btn-secondary" onclick="setDayType('training')">ğŸ‹ï¸ Training</button>
                <button class="btn btn-secondary" onclick="setDayType('repos')">ğŸ’¤ Repos</button>
                <button class="btn btn-secondary" onclick="toggleAutoMode()" id="btn-toggle-auto" style="font-size: 11px; padding: 6px 10px;">ğŸ”„ Auto</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('menu')">ğŸ“‹ MENU</button>
            <button class="tab" onclick="showTab('suivi10sem')">ğŸ“Š SUIVI</button>
            <button class="tab" onclick="showTab('saison')">ğŸ‚ SAISON</button>
            <button class="tab" onclick="showTab('supplements')">ğŸ’Š STACK</button>
            <button class="tab" onclick="showTab('ajustements')">âš™ï¸ AJUST</button>
            <button class="tab" onclick="showTab('grignotages')">ğŸª SNACKS</button>
            <button class="tab" onclick="showTab('export')">ğŸ“¤ EXPORT</button>
        </div>

        <div id="tab-menu" class="tab-content active">
            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 10px;">ğŸ“Š Progression du jour</h3>
                <div class="progress-bar-container"><div class="progress-bar" id="progress-bar" style="width: 0%">0%</div></div>
                <div class="macro-grid">
                    <div class="macro-card calories"><div class="macro-label">Calories</div><div class="macro-value"><span id="cal-actuel">0</span>/<span id="cal-total">2580</span></div></div>
                    <div class="macro-card proteines"><div class="macro-label">ProtÃ©ines</div><div class="macro-value"><span id="prot-actuel">0</span>/<span id="prot-total">240</span>g</div></div>
                    <div class="macro-card glucides"><div class="macro-label">Glucides</div><div class="macro-value"><span id="gluc-actuel">0</span>/<span id="gluc-total">250</span>g</div></div>
                    <div class="macro-card lipides"><div class="macro-label">Lipides</div><div class="macro-value"><span id="lip-actuel">0</span>/<span id="lip-total">75</span>g</div></div>
                </div>
            </div>
            <div id="menu-container"></div>
            <textarea class="notes-area" id="notes-jour" placeholder="ğŸ“ Notes du jour (Ã©nergie, sensations, digestion...)" oninput="showAutoSave()"></textarea>
        </div>

        <div id="tab-suivi10sem" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š Suivi Plan SÃ¨che 10 Semaines</h2>
            
            <div id="carte-semaine-actuelle"></div>
            
            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“ˆ Ã‰volution Poids & Mensurations</h3>
                <div class="chart-container" id="chart-poids">
                    <svg class="chart-svg" id="svg-poids"></svg>
                </div>
            </div>

            <div id="alertes-container"></div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“‹ Historique PesÃ©es</h3>
                <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="ouvrirFormulairePesee()">âš–ï¸ Nouvelle pesÃ©e (Vendredi/Samedi)</button>
                <div id="historique-pesees"></div>
            </div>
        </div>

        <div id="tab-saison" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ‚ Fruits & LÃ©gumes de Saison</h2>
            <div class="info-box"><strong>ğŸ“… Saison actuelle :</strong> <span id="season-name-detail">Automne</span> (mise Ã  jour automatique)</div>
            <div class="progress-card"><h3>ğŸ Fruits disponibles</h3><div id="fruits-saison" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div></div>
            <div class="progress-card"><h3>ğŸ¥¦ LÃ©gumes disponibles</h3><div id="legumes-saison" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div></div>
        </div>

        <!-- ğŸ†• NOUVEAU ONGLET STACK SUPPLÃ‰MENTS -->
        <div id="tab-supplements" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ’Š Stack 10 SupplÃ©ments OptimisÃ©</h2>

            <div class="alert-box alert-info">
                <strong>ğŸ“Š COÃ›T TOTAL MENSUEL</strong><br>
                â€¢ 10 supplÃ©ments : ~150â‚¬/mois (~5â‚¬/jour)<br>
                â€¢ Ã‰quilibre optimal : Performance + SantÃ© mÃ©tabolique + Articulations
            </div>

            <div class="alert-box alert-success" style="margin-top: 15px;">
                <strong>âœ… TIMING OPTIMAL</strong><br>
                â€¢ <strong>Matin Ã  jeun (7h30)</strong> : Vitamine D3<br>
                â€¢ <strong>Repas 1 (12h)</strong> : BerbÃ©rine, MSM, CrÃ©atine, CollagÃ¨ne<br>
                â€¢ <strong>Pendant journÃ©e (16h-18h)</strong> : BerbÃ©rine (3Ã¨me dose)<br>
                â€¢ <strong>Soir (22h)</strong> : OmÃ©ga-3, MagnÃ©sium, Zinc, Vit C, Curcuma, CollagÃ¨ne, BerbÃ©rine
            </div>

            <div id="stack-basique-container"></div>
            <div id="stack-diabete-container"></div>
            <div id="stack-cholesterol-container"></div>
        </div>

        <!-- ğŸ†• NOUVEAU ONGLET AJUSTEMENTS MACROS -->
        <div id="tab-ajustements" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">âš™ï¸ Ajustements Macros</h2>

            <!-- ğŸ†• SECTION MODULATION MACROS PAR SEMAINE -->
            <div class="progress-card" style="margin-bottom: 20px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ¯ Modulation Macros par Semaine</h3>
                <div class="alert-box alert-info" style="margin-bottom: 15px;">
                    <strong>ğŸ“Š Macros actuelles - ${semaineActuelle}</strong><br>
                    Ajuste facilement tes objectifs en fonction de tes rÃ©sultats
                </div>
                <div id="modulation-macros-container"></div>
            </div>

            <!-- ğŸ†• SECTION OPTIONS RATTRAPAGE -->
            <div class="progress-card" style="margin-bottom: 20px;">
                <h3 style="color: #ff6b6b; margin-bottom: 15px;">ğŸ”„ Options Rattrapage</h3>
                <div class="alert-box alert-warning" style="margin-bottom: 15px;">
                    <strong>âš ï¸ Pris du retard ?</strong><br>
                    Active les options ci-dessous pour compenser et rester sur les objectifs
                </div>
                <div id="rattrapage-options-container"></div>
            </div>

            <div class="alert-box alert-warning">
                <strong>âš ï¸ QUAND UTILISER CES AJUSTEMENTS ?</strong><br>
                Les menus standards donnent ~200g P / 320g G / 65g L<br>
                Si ta perte de poids stagne >2 semaines, utilise ces ajustements pour respecter STRICTEMENT les macros cibles (240P / 250G / 75L)
            </div>

            <div id="ajustements-container"></div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ’¡ DÃ©tails Nutritionnels par Aliment</h3>
                <div id="details-nutritionnels-container"></div>
            </div>
        </div>

        <div id="tab-grignotages" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸª Grignotages</h2>
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 15px;" onclick="openGrignotageModal()">+ Ajouter grignotage</button>
            <div class="grignotage-section" id="liste-grignotages"><p style="color: #999; text-align: center;">Aucun grignotage aujourd'hui ğŸ‘</p></div>
            <div class="progress-card"><h3>Total grignotages : <span id="total-grignotages" style="color: #ffc107;">+0 kcal</span></h3></div>
        </div>

        <div id="tab-export" class="tab-content">
            <h2 style="color: #667eea; margin-bottom: 15px;">ğŸ“¤ Export & Sauvegarde</h2>
            
            <div class="alert-box alert-info" style="margin-bottom: 20px;">
                <strong>ğŸ’¾ SAUVEGARDE TES DONNÃ‰ES !</strong><br>
                Les donnÃ©es sont stockÃ©es uniquement dans ton navigateur.<br>
                Fais un backup rÃ©gulier pour ne rien perdre !
            </div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ’¾ Sauvegarde complÃ¨te</h3>
                <button class="btn btn-success" style="width: 100%; margin: 10px 0;" onclick="telechargerBackup()">ğŸ’¾ TÃ©lÃ©charger backup (.json)</button>
                <button class="btn btn-primary" style="width: 100%; margin: 10px 0;" onclick="document.getElementById('input-restore').click()">ğŸ“¥ Restaurer backup</button>
                <input type="file" id="input-restore" accept=".json" style="display: none;" onchange="restaurerBackup(event)">
                <div style="font-size: 12px; color: #999; margin-top: 10px; text-align: center;">
                    Dernier backup : <span id="last-backup-date">Jamais</span>
                </div>
            </div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“‹ Rapports texte</h3>
                <button class="btn btn-primary" style="width: 100%; margin: 10px 0;" onclick="exportRapport()">ğŸ“‹ Copier rapport du jour</button>
                <button class="btn btn-secondary" style="width: 100%; margin: 10px 0;" onclick="exportRapportSemaine()">ğŸ“Š Copier rapport semaine</button>
            </div>

            <div class="progress-card">
                <h3 style="color: #667eea; margin-bottom: 15px;">âš™ï¸ Gestion</h3>
                <button class="btn btn-danger" style="width: 100%; margin: 10px 0;" onclick="resetJour()">ğŸ”„ Reset jour actuel</button>
                <button class="btn btn-danger" style="width: 100%; margin: 10px 0;" onclick="resetSemaine()">âš ï¸ Reset semaine actuelle</button>
                <button class="btn btn-danger" style="width: 100%;" onclick="resetTout()">ğŸ—‘ï¸ Effacer toutes les donnÃ©es</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-pesee">
        <div class="modal-content">
            <div class="modal-header">âš–ï¸ Nouvelle PesÃ©e Hebdomadaire</div>
            <div class="modal-body">
                <div class="info-box" style="margin-bottom: 15px;">
                    <strong>ğŸ“… PesÃ©e idÃ©ale :</strong> Vendredi ou Samedi matin, Ã  jeun, aprÃ¨s toilettes
                </div>
                <div class="form-group">
                    <label class="form-label">Semaine concernÃ©e</label>
                    <select class="form-input" id="input-semaine">
                        <option value="S1">S1 - SÃ¨che</option>
                        <option value="S2">S2 - SÃ¨che</option>
                        <option value="S3">S3 - SÃ¨che</option>
                        <option value="S4">S4 - SÃ¨che</option>
                        <option value="S5">S5 - Deload</option>
                        <option value="S6">S6 - SÃ¨che</option>
                        <option value="S7">S7 - SÃ¨che</option>
                        <option value="S8">S8 - SÃ¨che</option>
                        <option value="S9">S9 - SÃ¨che</option>
                        <option value="S10">S10 - Finale</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">âš–ï¸ Poids (kg) *</label>
                        <input type="number" step="0.1" class="form-input" id="input-poids" placeholder="Ex: 92.5">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“Š % Graisse *</label>
                        <input type="number" step="0.1" class="form-input" id="input-bf" placeholder="Ex: 23.5">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">ğŸ“ Tour taille (cm)</label>
                        <input type="number" step="0.5" class="form-input" id="input-taille" placeholder="Ex: 103">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ’ª Tour bras (cm)</label>
                        <input type="number" step="0.5" class="form-input" id="input-bras" placeholder="Ex: 38">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">âš¡ Ã‰nergie (/10)</label>
                        <input type="number" min="1" max="10" class="form-input" id="input-energie" placeholder="8">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸŒ¿ Digestion (/10)</label>
                        <input type="number" min="1" max="10" class="form-input" id="input-digestion" placeholder="8">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ Notes</label>
                    <textarea class="notes-area" id="input-notes-pesee" placeholder="Sensations, Ã©nergie training, points Ã  amÃ©liorer..." style="min-height: 60px;"></textarea>
                </div>
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('modal-pesee')">Annuler</button>
                <button class="btn btn-success" style="flex: 1;" onclick="enregistrerPesee()">ğŸ’¾ Enregistrer</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-grignotage">
        <div class="modal-content">
            <div class="modal-header">ğŸª Ajouter grignotage</div>
            <div class="modal-body">
                <input type="text" class="form-input" id="input-aliment" placeholder="Aliment (ex: Chocolat noir)">
                <input type="number" class="form-input" id="input-quantite" placeholder="QuantitÃ© (g)">
                <input type="number" class="form-input" id="input-calories" placeholder="Calories">
            </div>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-secondary" style="flex: 1;" onclick="closeModal('modal-grignotage')">Annuler</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="ajouterGrignotage()">Ajouter</button>
            </div>
        </div>
    </div>

    <script>
// ğŸ†• Saisons simplifiÃ©es
const SAISONS={automne:{mois:[9,10,11],nom:'Automne',emoji:'ğŸ‚',fruits:['Pomme','Poire','Raisin'],legumes:['Courge','Potimarron','Carottes','Courgettes','Brocoli','Haricots verts','Ã‰pinards']},hiver:{mois:[12,1,2],nom:'Hiver',emoji:'â„ï¸',fruits:['Pomme','Poire','Orange','Kiwi'],legumes:['Carottes','Courge','Ã‰pinards','Brocoli']},printemps:{mois:[3,4,5],nom:'Printemps',emoji:'ğŸŒ¸',fruits:['Fraise','Cerise','Pomme'],legumes:['Carottes','Haricots verts','Ã‰pinards','Asperges']},ete:{mois:[6,7,8],nom:'Ã‰tÃ©',emoji:'â˜€ï¸',fruits:['PÃªche','Abricot','Melon'],legumes:['Courgettes','Haricots verts','Carottes','Tomate']}};

// ğŸ†• PLAN SÃˆCHE 10 SEMAINES - MACROS CORRIGÃ‰ES (P220g rÃ©aliste)
const PLAN_HYBRIDE = {
    dateDebut: new Date().toISOString().split('T')[0],
    poidsInitial: 93.4,
    tailleInitiale: 105,
    semaines: {
        S1: {phase:'seche',nom:'SÃ¨che S1',objectif:'Kickstart sÃ¨che intensive',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S2: {phase:'seche',nom:'SÃ¨che S2',objectif:'AccÃ©lÃ©ration perte gras',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S3: {phase:'seche',nom:'SÃ¨che S3',objectif:'Momentum optimal',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S4: {phase:'seche',nom:'SÃ¨che S4',objectif:'Finalisation phase 1',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S5: {phase:'deload',nom:'Deload',objectif:'RÃ©cupÃ©ration mÃ©tabolique',calories:{training:2750,repos:2350},macros:{training:{P:230,G:280,L:85},repos:{P:220,G:200,L:95}},deficitCible:350,perteVisee:0.3,couleur:'#ffc107'},
        S6: {phase:'seche',nom:'SÃ¨che S6',objectif:'Reprise intensitÃ©',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S7: {phase:'seche',nom:'SÃ¨che S7',objectif:'Continuation sÃ¨che',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S8: {phase:'seche',nom:'SÃ¨che S8',objectif:'Phase finale approche',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S9: {phase:'seche',nom:'SÃ¨che S9',objectif:'DerniÃ¨re ligne droite',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.6,couleur:'#ff6b6b'},
        S10: {phase:'finale',nom:'Finale',objectif:'Bilan final & transition',calories:{training:2585,repos:2115},macros:{training:{P:240,G:220,L:85},repos:{P:240,G:105,L:85}},deficitCible:415,perteVisee:0.5,couleur:'#51cf66'}
    }
};

// ğŸ†• NOUVEAU MENUS_BASE COMPLET AVEC SUPPLÃ‰MENTS
const MENUS_BASE = {
    training: {
        repas: [
            {
                id: 'repas1_training',
                nom: 'REPAS 1 - PrÃ©-Training',
                heure: '12:00',
                calories: 950,
                macros: {P: 80, G: 95, L: 30},
                note: 'â° Finir 1h45 avant training (13h45)',
                options: [
                    {
                        id: 'A',
                        nom: 'Option A - Poulet-Riz',
                        aliments: [
                            'ğŸ— Poulet blanc grillÃ© : 250g cru â†’ 200g cuit',
                            'ğŸš Riz basmati : 75g cru â†’ 225g cuit',
                            'ğŸ¥¦ LÃ©gumes vapeur : 300g cru â†’ 250g cuit',
                            'ğŸ«’ Huile olive : 20ml',
                            'ğŸ¥‘ Avocat : 50g (1/3 moyen)'
                        ]
                    },
                    {
                        id: 'B',
                        nom: 'Option B - Dinde-Quinoa',
                        aliments: [
                            'ğŸ¦ƒ Escalope dinde : 300g cru â†’ 240g cuit',
                            'ğŸŒ¾ Quinoa : 65g cru â†’ 195g cuit',
                            'ğŸ¥¦ Haricots verts : 350g',
                            'ğŸ«’ Huile olive : 15ml',
                            'ğŸŒ Banane : 120g'
                        ]
                    },
                    {
                        id: 'C',
                        nom: 'Option C - BÅ“uf-PÃ¢tes',
                        aliments: [
                            'ğŸ¥© BÅ“uf hachÃ© 5% : 270g cru â†’ 220g cuit',
                            'ğŸ PÃ¢tes complÃ¨tes : 65g crues â†’ 195g cuites',
                            'ğŸ¥¬ Ã‰pinards : 350g',
                            'ğŸ«’ Huile olive : 15ml',
                            'ğŸŒ Banane : 120g'
                        ]
                    },
                    {
                        id: 'D',
                        nom: 'Option D - Poisson-Riz',
                        aliments: [
                            'ğŸŸ Cabillaud/Colin : 300g cru â†’ 240g cuit',
                            'ğŸš Riz basmati : 70g cru â†’ 210g cuit',
                            'ğŸ¥’ Courgettes : 350g',
                            'ğŸ«’ Huile olive : 15ml',
                            'ğŸŒ Banane : 120g'
                        ]
                    }
                ],
                // ğŸ†• SupplÃ©ments associÃ©s au repas
                supplements: [
                    'ğŸ’Š ARTICULATIONS (avec repas gras) :',
                    'âœ… Glucosamine : 1500mg (1 comprimÃ©)',
                    'âœ… ChondroÃ¯tine : 1200mg (1 comprimÃ©)',
                    'âœ… MSM : 2000mg (2 gÃ©lules)',
                    'âœ… Acide Hyaluronique : 200mg (1 gÃ©lule)',
                    'âœ… Boswellia : 500mg (1 gÃ©lule)',
                    '',
                    'ğŸ’Š DIABÃˆTE :',
                    'âœ… BerbÃ©rine : 500mg (1 gÃ©lule) ğŸ†•',
                    '',
                    'ğŸ’Š AUTRES :',
                    'âœ… CrÃ©atine : 5g (dans eau/thÃ©)',
                    'âœ… CollagÃ¨ne : 10g (dans cafÃ©/thÃ© chaud)'
                ],
                // ğŸ†• Ajouts anti-inflammatoires
                antiInflammatoires: [
                    'ğŸŒ¿ Curcuma frais : 5g (saupoudrer)',
                    'ğŸ«š Gingembre frais : 5g (rÃ¢per)',
                    'ğŸ§„ Ail cru : 1 gousse (hacher, attendre 10 min)',
                    'âš« Poivre noir : PincÃ©e (Ã—2000 absorption curcuma)'
                ]
            },
            {
                id: 'repas2_training',
                nom: 'REPAS 2 - Post-Training',
                heure: '15:45',
                calories: 765,
                macros: {P: 80, G: 105, L: 5},
                note: 'â° Dans les 30 min post-training MAX',
                aliments: [
                    'ğŸ’ª SHAKER ANTI-INFLAMMATOIRE :',
                    'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”',
                    'ğŸ’ª Whey isolate nature : 80g',
                    'ğŸŒ Bananes mÃ»res : 200g (1.5 moyennes)',
                    'ğŸ¥£ Flocons avoine : 40g secs â†’ 80g rÃ©hydratÃ©s',
                    'ğŸ’ Jus cerise acide : 150ml (Montmorency)',
                    'ğŸ« Myrtilles surgelÃ©es : 100g',
                    'ğŸ¯ Miel : 10g (1 c. cafÃ©, optionnel)',
                    'ğŸ’§ Eau : 200ml + glace',
                    '',
                    'ğŸ”„ MIXER 30 sec = Shake 750ml',
                    '',
                    'ğŸ’° CoÃ»t : ~2.80â‚¬'
                ]
            },
            {
                id: 'repas3_training',
                nom: 'REPAS 3 - Final',
                heure: '19:30',
                calories: 870,
                macros: {P: 80, G: 20, L: 50},
                note: 'ğŸ½ï¸ Version standard Lun/Mer',
                options: [
                    {
                        id: 'A',
                        nom: 'Option A - Poulet-Riz',
                        aliments: [
                            'ğŸ— Poulet blanc grillÃ© : 300g cru â†’ 240g cuit',
                            'ğŸš Riz basmati : 20g cru â†’ 60g cuit',
                            'ğŸ¥— Salade verte + lÃ©gumes crus : 300g',
                            'ğŸ«’ Huile olive : 25ml',
                            'ğŸŒ° Graines lin moulues : 15g',
                            '',
                            'ğŸŒ¿ AJOUTS :',
                            'â€¢ Curcuma frais : 3g',
                            'â€¢ Gingembre : 3g',
                            'â€¢ Ail cru : 1 gousse'
                        ]
                    },
                    {
                        id: 'B',
                        nom: 'Option B - Saumon-LÃ©gumes',
                        aliments: [
                            'ğŸŸ Saumon sauvage : 250g cru â†’ 200g cuit',
                            'ğŸ¥— Salade + lÃ©gumes : 400g',
                            'ğŸ«’ Huile olive : 20ml',
                            'ğŸŒ° Graines lin : 15g',
                            '',
                            'ğŸŒ¿ AJOUTS identiques'
                        ]
                    },
                    {
                        id: 'C',
                        nom: 'ğŸŸ VENDREDI - Frites',
                        aliments: [
                            'âš ï¸ ORDRE IMPORTANT :',
                            '1ï¸âƒ£ SALADE (manger en premier) :',
                            'ğŸ¥— Salade verte : 200g',
                            'ğŸ«’ Huile olive : 10ml',
                            'ğŸŒ° Graines lin : 15g',
                            '',
                            '2ï¸âƒ£ VIANDE (puis viande) :',
                            'ğŸ¥© Steak bÅ“uf 5% OU Poulet : 300g cru â†’ 240g cuit',
                            '',
                            '3ï¸âƒ£ FRITES (en dernier) :',
                            'ğŸŸ Pommes terre : 250g crues â†’ 215g frites',
                            'â†’ Air Fryer + spray huile 5ml',
                            '',
                            'âš ï¸ -100g vs avant = Macros respectÃ©es',
                            'ğŸ’° Total : 776 kcal (P:79 G:54 L:27)'
                        ]
                    }
                ],
                // ğŸ†• SupplÃ©ments spÃ©cifiques soir
                supplements: []
            }
        ],
        // ğŸ†• Nouvelle structure pour supplÃ©ments globaux
        supplementsGlobaux: [
            {
                moment: 'MATIN (7h30, Ã  jeun)',
                liste: [
                    'â˜• CafÃ© noir : 1-2 tasses (300mg cafÃ©ine)',
                    'ğŸ’Š Vitamine D3 : 5000 UI (1 capsule)',
                    'ğŸ’§ Eau : 500ml'
                ]
            },
            {
                moment: 'PENDANT TRAINING (14h-15h30)',
                liste: [
                    'âš ï¸ PAS d\'intra-workout en sÃ¨che',
                    'ğŸ’§ Eau : 750ml-1L',
                    'ğŸ§‚ Sel : 1g (pincÃ©e)',
                    'ğŸ’Š CrÃ©atine : 5g (si pas pris repas 1)'
                ]
            },
            {
                moment: 'SOIR (22h00, avant coucher)',
                liste: [
                    'ğŸ’Š ARTICULATIONS :',
                    'â€¢ OmÃ©ga-3 EPA/DHA : 4g (4 capsules)',
                    '  â†’ âš ï¸ 2g seulement si saumon/poisson gras dÃ®ner',
                    'â€¢ Curcuma + Poivre noir : 1000mg + 20mg',
                    'â€¢ Boswellia : 500mg (1 gÃ©lule)',
                    'â€¢ CollagÃ¨ne : 5g (eau chaude)',
                    '',
                    'ğŸ’Š RÃ‰CUPÃ‰RATION :',
                    'â€¢ MagnÃ©sium bisglycinate : 400mg',
                    'â€¢ Zinc : 30mg',
                    'â€¢ Vitamine C : 1000mg',
                    'â€¢ Glycine : 5g (sommeil +15%)',
                    '',
                    'ğŸ’Š DIABÃˆTE (glycÃ©mie 1.09) :',
                    'â€¢ BerbÃ©rine : 500mg (PRIORITÃ‰) ğŸ†•',
                    'â€¢ Chrome picolinate : 200mcg ğŸ†•',
                    '',
                    'ğŸ’§ Eau : 500ml'
                ]
            }
        ]
    },
    repos: {
        repas: [
            {
                id: 'repas1_repos',
                nom: 'REPAS 1',
                heure: '12:00',
                calories: 850,
                macros: {P: 80, G: 70, L: 30},
                options: [
                    {
                        id: 'A',
                        nom: 'Option A - Poulet-Riz',
                        aliments: [
                            'ğŸ— Poulet blanc : 300g cru â†’ 240g cuit',
                            'ğŸš Riz basmati : 80g cru â†’ 240g cuit',
                            'ğŸ¥¦ LÃ©gumes : 350g cru â†’ 300g cuit',
                            'ğŸ«’ Huile olive : 15ml'
                        ]
                    },
                    {
                        id: 'B',
                        nom: 'Option B - Dinde-Quinoa',
                        aliments: [
                            'ğŸ¦ƒ Dinde : 300g cru â†’ 240g cuit',
                            'ğŸŒ¾ Quinoa : 70g cru â†’ 210g cuit',
                            'ğŸ¥¦ LÃ©gumes : 350g',
                            'ğŸ«’ Huile olive : 15ml'
                        ]
                    },
                    {
                        id: 'C',
                        nom: 'Option C - BÅ“uf-Patate',
                        aliments: [
                            'ğŸ¥© BÅ“uf 5% : 270g cru â†’ 220g cuit',
                            'ğŸ  Patate douce : 280g crue â†’ 250g cuite',
                            'ğŸ¥¬ LÃ©gumes : 350g',
                            'ğŸ«’ Huile olive : 15ml'
                        ]
                    }
                ],
                // ğŸ†• SupplÃ©ments identiques training
                supplements: [
                    'ğŸ’Š ARTICULATIONS (avec repas) :',
                    'âœ… Glucosamine : 1500mg',
                    'âœ… ChondroÃ¯tine : 1200mg',
                    'âœ… MSM : 2000mg',
                    'âœ… Acide Hyaluronique : 200mg',
                    'âœ… Boswellia : 500mg',
                    '',
                    'ğŸ’Š DIABÃˆTE :',
                    'âœ… BerbÃ©rine : 500mg ğŸ†•',
                    '',
                    'ğŸ’Š AUTRES :',
                    'âœ… CrÃ©atine : 5g',
                    'âœ… CollagÃ¨ne : 10g'
                ],
                antiInflammatoires: [
                    'ğŸŒ¿ Curcuma : 5g',
                    'ğŸ«š Gingembre : 5g',
                    'ğŸ§„ Ail : 1 gousse'
                ]
            },
            {
                id: 'repas2_repos',
                nom: 'COLLATION',
                heure: '16:00',
                calories: 330,
                macros: {P: 40, G: 20, L: 10},
                note: 'ğŸ’¡ Collation lÃ©gÃ¨re - ProtÃ©ines + peu glucides',
                options: [
                    {
                        id: 'A',
                        nom: 'Option A - Skyr',
                        aliments: [
                            'ğŸ¶ Skyr 0% : 200g (rÃ©duit)',
                            'ğŸŒ Banane : 120g',
                            'ğŸ¥œ Amandes : 15g (12 unitÃ©s)',
                            'ğŸ¯ Miel : 10g'
                        ]
                    },
                    {
                        id: 'B',
                        nom: 'Option B - Å’ufs',
                        aliments: [
                            'ğŸ¥š Å’ufs durs : 3 entiers',
                            'ğŸŒ Banane : 120g',
                            'ğŸŒ° Noix : 15g',
                            'ğŸ Pomme : 100g'
                        ]
                    },
                    {
                        id: 'C',
                        nom: 'Option C - Fromage blanc',
                        aliments: [
                            'ğŸ§€ Fromage blanc 0% : 250g',
                            'ğŸ« Fruits rouges : 80g',
                            'ğŸ¥œ Beurre cacahuÃ¨te : 10g',
                            'ğŸ¯ Miel : 10g'
                        ]
                    },
                    {
                        id: 'D',
                        nom: 'Option D - Whey Boost',
                        aliments: [
                            'ğŸ’ª Whey : 30g (+P si besoin)',
                            'ğŸŒ Banane : 120g',
                            'ğŸ¥› Lait avoine : 200ml',
                            'ğŸ¥œ Amandes : 10g'
                        ]
                    }
                ]
            },
            {
                id: 'repas3_repos',
                nom: 'REPAS 3 - Soir',
                heure: '19:30',
                calories: 935,
                macros: {P: 120, G: 15, L: 45},
                note: 'ğŸ½ï¸ GROS repas protÃ©inÃ© - LOW CARB',
                options: [
                    {
                        id: 'A',
                        nom: 'Option A - Saumon (Mar/Jeu/Sam)',
                        aliments: [
                            'ğŸŸ Saumon sauvage : 350g cru â†’ 280g cuit',
                            'ğŸ  Patate douce : 170g crue â†’ 150g cuite',
                            'ğŸ¥— Salade + lÃ©gumes : 350g',
                            'ğŸ«’ Huile olive : 25ml',
                            'ğŸŒ° Graines lin : 15g',
                            '',
                            'ğŸ’¡ ROTATION POISSON :',
                            'â€¢ Mardi : Saumon 350g',
                            'â€¢ Jeudi : Sardines 300g cru',
                            'â€¢ Samedi : Maquereaux 280g cru'
                        ]
                    },
                    {
                        id: 'B',
                        nom: 'Option B - Poulet (Dimanche)',
                        aliments: [
                            'ğŸ— Poulet : 300g cru â†’ 240g cuit',
                            'ğŸ¥” Pommes terre : 250g crues â†’ 200g vapeur',
                            'ğŸ¥¦ LÃ©gumes : 400g',
                            'ğŸ«’ Huile olive : 30ml',
                            'ğŸŒ° Graines lin : 15g'
                        ]
                    },
                    {
                        id: 'C',
                        nom: 'Option C - Å’ufs',
                        aliments: [
                            'ğŸ¥š Å’ufs entiers : 5 (omelette)',
                            'ğŸ  Patate douce : 220g crue â†’ 200g cuite',
                            'ğŸ¥¦ Mix lÃ©gumes : 400g',
                            'ğŸ«’ Huile olive : 20ml',
                            'ğŸ§€ Fromage rÃ¢pÃ© : 30g'
                        ]
                    }
                ],
                supplements: [
                    'ğŸ’§ BOUILLON OS (3-4Ã—/sem optionnel) :',
                    'â€¢ 250ml aprÃ¨s repas',
                    'â€¢ P: 10g / CollagÃ¨ne naturel',
                    '',
                    'ğŸ¶ SKYR (si besoin +protÃ©ines) :',
                    'â€¢ 100g = +10g protÃ©ines'
                ]
            }
        ],
        supplementsGlobaux: [
            {
                moment: 'MATIN (7h30, Ã  jeun)',
                liste: [
                    'â˜• CafÃ© noir',
                    'ğŸ’Š Vitamine D3 : 5000 UI',
                    'ğŸ’§ Eau : 500ml'
                ]
            },
            {
                moment: 'SOIR (22h00)',
                liste: [
                    'ğŸ’Š OmÃ©ga-3 : 2g (si poisson gras) ou 4g',
                    'ğŸ’Š Curcuma + Poivre : 1000mg',
                    'ğŸ’Š Boswellia : 500mg',
                    'ğŸ’Š CollagÃ¨ne : 5g',
                    'ğŸ’Š MagnÃ©sium : 400mg',
                    'ğŸ’Š Zinc : 30mg',
                    'ğŸ’Š Vitamine C : 1000mg',
                    'ğŸ’Š Glycine : 5g',
                    '',
                    'ğŸ’Š DIABÃˆTE :',
                    'â€¢ BerbÃ©rine : 500mg ğŸ†•',
                    'â€¢ Chrome : 200mcg ğŸ†•'
                ]
            }
        ]
    }
};

// ğŸ†• DÃ‰TAILS NUTRITIONNELS COMPLETS PAR ALIMENT (Plan Carb Cycling)
const DETAILS_NUTRITIONNELS = {
    training: {
        repas1: {
            cout: '~2.50â‚¬',
            total: {P: 80, G: 95, L: 30, kcal: 950},
            aliments: {
                poulet_300g: {P: 72, G: 0, L: 6, kcal: 336},  // 300g cru â†’ 240g cuit
                riz_70g: {P: 5, G: 59, L: 1, kcal: 265},  // 70g cru â†’ 210g cuit
                legumes_350g: {P: 9, G: 18, L: 1, kcal: 115},
                huile_15ml: {P: 0, G: 0, L: 15, kcal: 135},
                banane_120g: {P: 1, G: 27, L: 0, kcal: 110}
            },
            note: 'âœ… Pomme supprimÃ©e vs plan initial'
        },
        repas2: {
            cout: '~2.50â‚¬',
            total: {P: 80, G: 105, L: 5, kcal: 765},
            aliments: {
                whey_80g: {P: 68, G: 4, L: 1, kcal: 293},  // +20g vs avant
                bananes_240g: {P: 3, G: 54, L: 1, kcal: 220},  // 2 bananes (vs 3)
                flocons_40g: {P: 5, G: 24, L: 3, kcal: 150},  // 40g secs â†’ 80g rÃ©hydratÃ©s
                myrtilles_100g: {P: 1, G: 12, L: 0, kcal: 50},
                miel_10g: {P: 0, G: 8, L: 0, kcal: 30},
                cannelle_5g: {P: 0, G: 0, L: 0, kcal: 0}
            },
            note: 'âœ… Jus cerise supprimÃ© vs plan initial'
        },
        repas3: {
            cout: '~2.80â‚¬',
            total: {P: 80, G: 20, L: 50, kcal: 870},
            aliments: {
                poulet_300g: {P: 72, G: 0, L: 6, kcal: 336},  // Option A dÃ©sormais
                riz_20g: {P: 2, G: 17, L: 0, kcal: 76},  // 20g cru â†’ 60g cuit
                salade_300g: {P: 4, G: 12, L: 1, kcal: 70},
                huile_25ml: {P: 0, G: 0, L: 25, kcal: 225},  // +10ml vs avant
                graines_lin_15g: {P: 3, G: 0, L: 6, kcal: 75}
            },
            note: 'âœ… Poulet remplace saumon, riz drastiquement rÃ©duit'
        },
        repas3_vendredi: {
            cout: '~2.50â‚¬',
            total: {P: 79, G: 54, L: 27, kcal: 776},
            aliments: {
                salade_200g: {P: 2, G: 4, L: 0, kcal: 25},
                poulet_300g: {P: 72, G: 0, L: 6, kcal: 336},
                frites_250g: {P: 6, G: 50, L: 9, kcal: 290},  // 250g crues â†’ 215g frites
                huile_spray_5ml: {P: 0, G: 0, L: 5, kcal: 45},  // Air Fryer
                graines_lin_15g: {P: 3, G: 0, L: 6, kcal: 75}
            },
            note: 'âœ… Frites rÃ©duites 350gâ†’250g, macros respectÃ©es'
        }
    },
    repos: {
        repas1: {
            cout: '~2.50â‚¬',
            total: {P: 80, G: 70, L: 30, kcal: 850},
            aliments: {
                poulet_300g: {P: 72, G: 0, L: 6, kcal: 336},  // +50g vs avant
                riz_80g: {P: 6, G: 67, L: 1, kcal: 303},  // 80g cru â†’ 240g cuit
                legumes_350g: {P: 9, G: 18, L: 1, kcal: 115},  // -50g vs avant
                huile_15ml: {P: 0, G: 0, L: 15, kcal: 135}  // -5ml vs avant
            },
            note: 'âœ… Pomme supprimÃ©e, poulet augmentÃ©'
        },
        collation: {
            cout: '~1.50â‚¬',
            total: {P: 40, G: 20, L: 10, kcal: 330},
            aliments: {
                skyr_200g: {P: 20, G: 8, L: 0, kcal: 112},  // -50g vs avant
                flocons_40g: {P: 5, G: 24, L: 3, kcal: 150},
                myrtilles_100g: {P: 1, G: 12, L: 0, kcal: 50},
                amandes_15g: {P: 3, G: 2, L: 8, kcal: 90},  // -5g vs avant
                cannelle_2g: {P: 0, G: 0, L: 0, kcal: 0}
            },
            note: 'âœ… Portions rÃ©duites pour baisser calories'
        },
        repas3: {
            cout: '~4.50â‚¬',
            total: {P: 120, G: 15, L: 45, kcal: 935},
            aliments: {
                saumon_350g: {P: 70, G: 0, L: 21, kcal: 490},  // 350g cru â†’ 280g cuit
                patate_douce_170g: {P: 3, G: 34, L: 0, kcal: 148},  // 170g crue â†’ 150g cuite
                legumes_200g: {P: 5, G: 10, L: 1, kcal: 65},
                huile_25ml: {P: 0, G: 0, L: 25, kcal: 225},
                graines_lin_15g: {P: 3, G: 0, L: 6, kcal: 75}
            },
            note: 'âœ… Saumon massif +170g, glucides rÃ©duits'
        }
    }
};

// ğŸ†• OPTIONS AJUSTEMENT MACROS (si plateau perte poids)
const AJUSTEMENTS_MACROS = {
    training: {
        optionA: {
            nom: 'Option A - Ã‰quilibrÃ© (RecommandÃ©)',
            description: 'Ajustements lÃ©gers pour approcher objectifs',
            repas1: {
                modifications: [
                    'ğŸ— Poulet : 300g cru â†’ 240g cuit (+20g protÃ©ines)',
                    'ğŸš Riz : 80g cru â†’ 240g cuit (-8g glucides)',
                    'Reste inchangÃ©'
                ],
                macros: {P: 90, G: 125, L: 22, kcal: 1050}
            },
            repas2: {
                modifications: ['InchangÃ©'],
                macros: {P: 62, G: 148, L: 5, kcal: 860}
            },
            repas3: {
                modifications: [
                    'ğŸŸ Saumon : 200g cru â†’ 160g cuit (+3g protÃ©ines)',
                    'ğŸš Riz : 40g cru â†’ 120g cuit (-8g glucides)',
                    'Reste inchangÃ©'
                ],
                macros: {P: 48, G: 48, L: 35, kcal: 685}
            },
            total: {P: 200, G: 321, L: 62, kcal: 2595},
            note: 'âœ… Proche objectifs, bon compromis satiÃ©tÃ©/performance'
        },
        optionB: {
            nom: 'Option B - Strict Macros (Si plateau)',
            description: 'Ajustements stricts pour respecter EXACTEMENT macros',
            repas1: {
                modifications: [
                    'ğŸ— Poulet : 300g cru â†’ 240g cuit',
                    'ğŸš Riz : 70g cru â†’ 210g cuit (-17g glucides)',
                    'ğŸ«’ Huile : 10ml (-5ml = -5g lipides)',
                    'ğŸŒ Banane : SUPPRIMÃ‰E (-27g glucides)'
                ],
                macros: {P: 90, G: 114, L: 17, kcal: 945}
            },
            repas2: {
                modifications: [
                    'ğŸŒ Bananes : 2 au lieu de 3 (-27g glucides)',
                    'ğŸ¥£ Flocons : 30g au lieu 40g (-6g glucides)',
                    'Reste inchangÃ©'
                ],
                macros: {P: 62, G: 107, L: 4, kcal: 700}
            },
            repas3: {
                modifications: [
                    'ğŸŸ Saumon : 200g cru (+3g protÃ©ines)',
                    'ğŸš Riz : SUPPRIMÃ‰ (-42g glucides)',
                    'ğŸ  Patate douce : 150g (+30g glucides)',
                    'ğŸ«’ Huile : 20ml (+5ml = +5g lipides)'
                ],
                macros: {P: 50, G: 42, L: 48, kcal: 740}
            },
            total: {P: 202, G: 263, L: 69, kcal: 2385},
            note: 'âš ï¸ Plus restrictif, utiliser SI perte stagne >2 semaines'
        }
    }
};

// ğŸ†• STACK 10 SUPPLÃ‰MENTS OPTIMISÃ‰ (Ã©quilibre parfait)
const STACK_SUPPLEMENTS_COMPLET = {
    matin_jeun: {
        titre: 'MATIN Ã€ JEUN',
        horaire: '7h30',
        supplements: [
            {nom: 'Vitamine D3', dose: '5000 UI', quantite: '1 capsule', diabete: 'âœ…âœ… Positif'}
        ]
    },
    repas_1: {
        titre: 'REPAS 1 (12h)',
        supplements: [
            {nom: 'BerbÃ©rine', dose: '500mg', quantite: '1 gÃ©lule', diabete: 'âœ…âœ… PrioritÃ© #1', effet: 'GlycÃ©mie -20%'},
            {nom: 'MSM', dose: '2000mg', quantite: '2 gÃ©lules', diabete: 'âœ… Neutre', effet: '-82% inflammation'},
            {nom: 'CrÃ©atine', dose: '5g', quantite: '1 dose', diabete: 'âœ… Neutre'},
            {nom: 'CollagÃ¨ne', dose: '10g', quantite: '1 dose', diabete: 'âœ… Neutre', effet: 'Tendons/peau'}
        ]
    },
    soir: {
        titre: 'SOIR (22h)',
        supplements: [
            {nom: 'OmÃ©ga-3', dose: '3g', quantite: '3 capsules', diabete: 'âœ…âœ… Positif', effet: 'Cardio + Inflamm'},
            {nom: 'MagnÃ©sium', dose: '400mg', quantite: '2 gÃ©lules', diabete: 'âœ…âœ… Positif', effet: 'Insuline â†‘'},
            {nom: 'Zinc', dose: '30mg', quantite: '1 gÃ©lule', diabete: 'âœ…âœ… Positif'},
            {nom: 'Vitamine C', dose: '1000mg', quantite: '1 comprimÃ©', diabete: 'âœ… Positif'},
            {nom: 'Curcuma', dose: '1000mg', quantite: '1 gÃ©lule', diabete: 'âœ… Neutre', effet: 'Anti-inflamm'},
            {nom: 'CollagÃ¨ne', dose: '5g', quantite: '2Ã¨me dose', diabete: 'âœ… Neutre'},
            {nom: 'BerbÃ©rine', dose: '500mg', quantite: '1 gÃ©lule', diabete: 'âœ…âœ… PrioritÃ© #1'}
        ]
    },
    journee: {
        titre: 'PENDANT JOURNÃ‰E',
        horaire: '16h-18h',
        supplements: [
            {nom: 'BerbÃ©rine', dose: '500mg', quantite: '3Ã¨me dose', diabete: 'âœ…âœ… PrioritÃ© #1'}
        ]
    },
    cout_total: {
        estimation_mensuelle: '~150â‚¬/mois',
        par_jour: '~5â‚¬/jour',
        note: '10 supplÃ©ments = Ã©quilibre optimal performance + santÃ© mÃ©tabolique'
    }
};

// ğŸ†• CONSEILS INTERACTIFS SEMAINE PAR SEMAINE
const CONSEILS_SEMAINES = {
    semaine: 1,
    phase: "Adaptation initiale",
    conseils: {
        jour_1_lundi: {
            titre: "ğŸ¯ Premier jour : L'ordre des repas compte",
            expert: "Dr. Spencer Nadolsky",
            conseil: "Commence TOUJOURS ton repas par les lÃ©gumes, puis les protÃ©ines, et ENFIN les glucides. Cette sÃ©quence rÃ©duit le pic de glycÃ©mie de 30-40%. Crucial avec ta glycÃ©mie 1.09.",
            etude: "Shukla et al. (2019) - Diabetes Care",
            action: "Aujourd'hui : Mange ta salade AVANT le poulet et le riz",
            pourquoi_toi: "GlycÃ©mie limite prÃ©-diabÃ¨te : ordre optimal"
        },
        jour_2_mardi: {
            titre: "ğŸ’§ Hydratation dÃ©ficit calorique",
            expert: "Dr. Eric Helms",
            conseil: "En dÃ©ficit -420 kcal, ton corps libÃ¨re toxines stockÃ©es dans le gras. Vise 3.5-4L eau/jour minimum. Urine jaune pÃ¢le = hydratation correcte.",
            etude: "Helms et al. (2014) - J Int Soc Sports Nutr",
            action: "Remplis une bouteille 2L ce matin, finis avant 16h. RÃ©pÃ¨te.",
            pourquoi_toi: "SÃ¨che + 44 ans = besoin hydratation +20%"
        },
        jour_3_mercredi: {
            titre: "ğŸ¥— LÃ©gumes = arme secrÃ¨te satiÃ©tÃ©",
            expert: "Dr. Ted Naiman",
            conseil: "600-700g lÃ©gumes/jour te donnent volume gastrique massif pour seulement 150 kcal. Impossible d'avoir faim avec ce volume. Fibres ralentissent absorption glucose.",
            etude: "Rolls et al. (2004) - Am J Clin Nutr",
            action: "VÃ©rifie que tu manges 300g+ lÃ©gumes aux repas 1 et 3",
            pourquoi_toi: "DÃ©ficit Ã©levÃ© + diabÃ¨te = besoin volume + fibres"
        },
        jour_4_jeudi: {
            titre: "ğŸ— 240g protÃ©ines NON-NÃ‰GOCIABLE",
            expert: "Dr. Layne Norton",
            conseil: "Masters 40+ perdent muscle 2Ã— plus vite que jeunes en sÃ¨che. Tes 240g protÃ©ines quotidiennes = ASSURANCE prÃ©servation. Descendre = perte muscle garantie.",
            etude: "Phillips & Van Loon (2011) - J Sports Sci",
            action: "Track tes protÃ©ines aujourd'hui, atteins 240g minimum",
            pourquoi_toi: "44 ans + dÃ©ficit = protÃ©ines CRUCIALES"
        },
        jour_5_vendredi: {
            titre: "ğŸŸ Frites vendredi = STRATÃ‰GIE, pas tricherie",
            expert: "Chris Aceto",
            conseil: "Refeed glucides 1Ã—/sem maintient leptine (hormone satiÃ©tÃ©), boost mÃ©tabolisme +10%, recharge glycogÃ¨ne. Psychologique : compliance +40%. C'est SCIENCE, pas faiblesse.",
            etude: "Dirlewanger et al. (2000) - Am J Clin Nutr",
            action: "Savoure tes frites SANS culpabilitÃ©. C'est dans le plan.",
            pourquoi_toi: "Compliance long terme > perfection court terme"
        },
        jour_6_samedi: {
            titre: "ğŸ§˜ McGill Big 3 = 8 min assurance zÃ©ro douleur",
            expert: "Dr. Stuart McGill",
            conseil: "7j/7, mÃªme repos. Lombaires = maillon faible humains. Big 3 = +32% rÃ©sistance blessure. CoÃ»t 8 min. ROI : infini (zÃ©ro lombalgie).",
            etude: "McGill (2015) - Back Mechanic",
            action: "Fais tes 3 exercices ce soir, chrono 8 min total",
            pourquoi_toi: "44 ans + musculation = prÃ©vention CRUCIALE"
        },
        jour_7_dimanche: {
            titre: "ğŸ“Š Bilan semaine 1 = DonnÃ©es OBJECTIVES",
            expert: "Dr. Mike Israetel",
            conseil: "Masters ont taux perte optimale 0.5-0.7%/sem (vs 1% jeunes). Si tu perds 0.6kg S1 = PARFAIT. Si 0.3kg = augmente cardio. Si 1kg+ = ralentis (trop rapide = muscle perdu).",
            etude: "Helms et al. (2014) - Evidence-based recommendations",
            action: "PÃ¨se-toi demain matin Ã  jeun. Compare vs poids initial.",
            pourquoi_toi: "Ã‚ge 44 = donnÃ©es > intuitions. Science > feeling."
        }
    }
};

function getSaison(){const mois=new Date().getMonth()+1;for(const[key,saison]of Object.entries(SAISONS)){if(saison.mois.includes(mois))return saison}return SAISONS.automne}
let SAISON_ACTUELLE=getSaison();

let semaineActuelle = 'S1';
let jourType = 'training';
let grignotages = [];
let pesees = JSON.parse(localStorage.getItem('pesees-hebdo') || '[]');
let derniereDateChargee = new Date().toISOString().split('T')[0];
let derniereSemaineChargee = 'S1';
let optionsSelectionnees = JSON.parse(localStorage.getItem('options-repas') || '{}');

// ğŸ†• FONCTION AFFICHAGE CONSEIL DU JOUR
function afficherConseilDuJour() {
    const today = new Date().toISOString().split('T')[0];
    const lastShown = localStorage.getItem('dernier-conseil-shown');

    // Ne montrer qu'une fois par jour
    if (lastShown === today) return;

    const jourSemaine = new Date().getDay();
    const joursMapping = {
        1: 'jour_1_lundi',
        2: 'jour_2_mardi',
        3: 'jour_3_mercredi',
        4: 'jour_4_jeudi',
        5: 'jour_5_vendredi',
        6: 'jour_6_samedi',
        0: 'jour_7_dimanche'
    };

    const jourKey = joursMapping[jourSemaine];
    const conseil = CONSEILS_SEMAINES.conseils[jourKey];

    if (!conseil) return;

    // Attendre 2 secondes aprÃ¨s le chargement
    setTimeout(() => {
        const overlay = document.createElement('div');
        overlay.className = 'conseil-popup-overlay';
        overlay.onclick = () => {
            document.body.removeChild(overlay);
            document.body.removeChild(popup);
            localStorage.setItem('dernier-conseil-shown', today);
        };

        const popup = document.createElement('div');
        popup.className = 'conseil-popup';
        popup.innerHTML = `
            <div style="text-align: center; margin-bottom: 15px;">
                <div style="font-size: 36px; margin-bottom: 10px;">ğŸ’¡</div>
                <h3 style="color: #667eea; margin-bottom: 5px; font-size: 18px;">${conseil.titre}</h3>
                <small style="color: #999; font-size: 11px;">Expert : ${conseil.expert}</small>
            </div>

            <div style="background: #f0f4ff; padding: 15px; border-radius: 12px; margin: 15px 0; border-left: 4px solid #667eea;">
                <p style="color: #333; line-height: 1.6; margin-bottom: 10px; font-size: 14px;">${conseil.conseil}</p>
            </div>

            <div style="background: #fff9e6; padding: 12px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffc107;">
                <strong style="color: #f57c00; font-size: 13px;">ğŸ¯ ACTION AUJOURD'HUI</strong><br>
                <p style="color: #666; margin-top: 5px; font-size: 13px;">${conseil.action}</p>
            </div>

            <div style="background: #e8f5e9; padding: 10px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #51cf66;">
                <strong style="color: #2e7d32; font-size: 12px;">âœ… Pourquoi TOI ?</strong><br>
                <small style="color: #666; font-size: 12px;">${conseil.pourquoi_toi}</small>
            </div>

            <div style="text-align: center; margin-top: 15px;">
                <small style="color: #999; font-size: 11px;">ğŸ“š ${conseil.etude}</small>
            </div>

            <button onclick="this.parentElement.parentElement.remove(); document.querySelector('.conseil-popup-overlay').remove(); localStorage.setItem('dernier-conseil-shown', '${today}');"
                    class="btn btn-primary" style="width: 100%; margin-top: 15px; padding: 12px;">
                âœ… Compris !
            </button>
        `;

        document.body.appendChild(overlay);
        document.body.appendChild(popup);
    }, 2000);
}

window.onload = function() {
    updateSeasonDisplay();
    semaineActuelle = getSemaineActuelle();
    derniereSemaineChargee = semaineActuelle;
    derniereDateChargee = new Date().toISOString().split('T')[0];
    loadDayType();
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    afficherSaison();
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    afficherAlertes();
    updateTimelineVisuel();
    afficherConseilDuJour(); // ğŸ†• Afficher conseil du jour

    setInterval(verifierChangementDate, 60000);
    setInterval(verifierValidationRepas, 300000); // VÃ©rifier toutes les 5 min
    setInterval(verifierRecapFinJournee, 300000); // VÃ©rifier toutes les 5 min
    setInterval(verifierSupplementsSoir, 300000); // ğŸ†• VÃ©rifier supplÃ©ments soir
    verifierEtNotifierChangementSemaine();
    verifierBackupHebdomadaire();
    verifierValidationRepas(); // VÃ©rification initiale
    verifierRecapFinJournee(); // VÃ©rification initiale
    verifierSupplementsSoir(); // ğŸ†• VÃ©rification initiale
};

function verifierBackupHebdomadaire() {
    const lastBackup = localStorage.getItem('last-backup');
    const aujourdhui = new Date();
    const jourSemaine = aujourdhui.getDay();
    
    if (jourSemaine === 0) {
        if (!lastBackup) {
            rappelBackup('Tu n\'as jamais fait de backup ! ğŸ’¾');
        } else {
            const dateLastBackup = new Date(lastBackup);
            const diffJours = Math.floor((aujourdhui - dateLastBackup) / (1000 * 60 * 60 * 24));
            
            if (diffJours >= 7) {
                rappelBackup(`Dernier backup il y a ${diffJours} jours ! ğŸ“…`);
            }
        }
    }
}

function rappelBackup(message) {
    const lastNotif = localStorage.getItem('derniere-notif-backup');
    const today = new Date().toISOString().split('T')[0];
    
    if (lastNotif === today) return;
    
    setTimeout(() => {
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 4000; max-width: 400px; text-align: center; animation: modalPop 0.5s;';
        notification.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ’¾</div>
            <h3 style="color: #667eea; margin-bottom: 10px;">Rappel Backup Hebdomadaire</h3>
            <p style="color: #666; margin-bottom: 20px;">${message}<br><small>ProtÃ¨ge tes donnÃ©es avec un backup !</small></p>
            <button onclick="this.parentElement.remove(); document.querySelector('.tab[onclick*=export]').click(); setTimeout(() => telechargerBackup(), 500);" style="background: linear-gradient(135deg, #51cf66 0%, #37b24d 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-right: 10px;">ğŸ’¾ Faire backup</button>
            <button onclick="this.parentElement.remove();" style="background: #f0f0f0; color: #666; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer;">Plus tard</button>
        `;
        document.body.appendChild(notification);
        
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3999;';
        overlay.onclick = () => {
            notification.remove();
            overlay.remove();
        };
        document.body.appendChild(overlay);
        
        localStorage.setItem('derniere-notif-backup', today);
    }, 3000);
}

function verifierChangementDate() {
    const dateActuelle = new Date().toISOString().split('T')[0];
    const semaineActuelle_check = getSemaineActuelle();

    if (dateActuelle !== derniereDateChargee) {
        derniereDateChargee = dateActuelle;

        // ğŸ†• Recharger le type de jour si en mode AUTO
        const autoMode = localStorage.getItem('autoMode') !== 'false';
        if (autoMode) {
            loadDayType();
        }

        afficherMenu();
        loadGrignotages();
        calculerProgression();

        // ğŸ†• NOTIFICATION VISUELLE CHANGEMENT DE JOUR
        showDayChangeNotification(semaineActuelle_check !== derniereSemaineChargee);
    }

    if (semaineActuelle_check !== derniereSemaineChargee) {
        derniereSemaineChargee = semaineActuelle_check;
        semaineActuelle = semaineActuelle_check;
        afficherMenu();
        afficherCarteSemaine();
        updateTimelineVisuel();
        calculerProgression();
    }
}

// ğŸ†• NOTIFICATION CHANGEMENT JOUR/SEMAINE
function showDayChangeNotification(isWeekChange) {
    const today = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    const dateStr = today.toLocaleDateString('fr-FR', options);
    const dayType = detecterJourType();
    const dayIcon = dayType === 'training' ? 'ğŸ‹ï¸' : 'ğŸ’¤';
    const dayLabel = dayType === 'training' ? 'TRAINING' : 'REPOS';

    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${isWeekChange ? 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' : 'white'};
        color: ${isWeekChange ? 'white' : '#333'};
        padding: 30px 40px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 5000;
        max-width: 450px;
        text-align: center;
        animation: modalPop 0.5s;
    `;

    if (isWeekChange) {
        const config = PLAN_HYBRIDE.semaines[semaineActuelle];
        notification.innerHTML = `
            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“…</div>
            <h2 style="margin-bottom: 10px; font-size: 28px;">Nouvelle Semaine !</h2>
            <div style="font-size: 18px; margin-bottom: 15px; opacity: 0.95;">
                ${semaineActuelle} - ${config.nom}
            </div>
            <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; margin: 15px 0;">
                <div style="font-size: 16px; margin-bottom: 8px;">${dateStr}</div>
                <div style="font-size: 24px; font-weight: bold;">${dayIcon} Jour ${dayLabel}</div>
            </div>
            <div style="font-size: 14px; margin-top: 15px; opacity: 0.9;">
                Objectif: ${config.objectif}<br>
                Perte visÃ©e: ${config.perteVisee} kg
            </div>
            <button onclick="this.parentElement.nextSibling.remove(); this.parentElement.remove();"
                    style="margin-top: 20px; padding: 12px 30px; background: white; color: #667eea; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;">
                C'est parti ! ğŸ’ª
            </button>
        `;
    } else {
        notification.innerHTML = `
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ“…</div>
            <h3 style="color: #667eea; margin-bottom: 15px; font-size: 22px;">Nouveau Jour</h3>
            <div style="background: #f0f4ff; padding: 15px; border-radius: 12px; margin: 15px 0;">
                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">${dateStr}</div>
                <div style="font-size: 22px; font-weight: bold; color: #333;">${dayIcon} Jour ${dayLabel}</div>
            </div>
            <button onclick="this.parentElement.nextSibling.remove(); this.parentElement.remove();"
                    style="margin-top: 15px; padding: 10px 25px; background: #667eea; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
                OK
            </button>
        `;
    }

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 4999;';
    overlay.onclick = () => {
        notification.remove();
        overlay.remove();
    };

    document.body.appendChild(overlay);
    document.body.appendChild(notification);
}

// ğŸ†• VÃ‰RIFICATION ET ALERTE VALIDATION REPAS
function verifierValidationRepas() {
    const now = new Date();
    const heure = now.getHours();
    const minutes = now.getMinutes();
    const today = new Date().toISOString().split('T')[0];
    const lastAlertDate = localStorage.getItem('last-meal-alert-date');
    const lastAlertTime = localStorage.getItem('last-meal-alert-time');

    // Alertes aux heures stratÃ©giques: 19h, 21h, 22h30
    const alertHours = [
        { h: 19, m: 0, label: 'soirÃ©e' },
        { h: 21, m: 0, label: 'tard' },
        { h: 22, m: 30, label: 'trÃ¨s tard' }
    ];

    let shouldAlert = false;
    let alertLabel = '';

    for (const alert of alertHours) {
        if (heure === alert.h && minutes >= alert.m && minutes < alert.m + 5) {
            const alertKey = `${alert.h}:${alert.m}`;
            if (lastAlertDate !== today || lastAlertTime !== alertKey) {
                shouldAlert = true;
                alertLabel = alert.label;
                localStorage.setItem('last-meal-alert-date', today);
                localStorage.setItem('last-meal-alert-time', alertKey);
                break;
            }
        }
    }

    if (!shouldAlert) return;

    // VÃ©rifier quels repas manquent
    const menu = MENUS_BASE[jourType];
    const repasManquants = menu.repas.filter(r => !isRepasValide(r.id));

    if (repasManquants.length === 0) return; // Tous validÃ©s, pas d'alerte

    // Afficher notification
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        padding: 25px 35px;
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(255,107,107,0.4);
        z-index: 5000;
        max-width: 400px;
        text-align: center;
        animation: shake 0.5s;
    `;

    const repasListeHTML = repasManquants.map(r =>
        `<div style="background: rgba(255,255,255,0.2); padding: 8px; border-radius: 8px; margin: 5px 0; font-size: 14px;">
            ${r.nom}
        </div>`
    ).join('');

    notification.innerHTML = `
        <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
        <h3 style="margin-bottom: 10px; font-size: 22px;">Repas non validÃ©s</h3>
        <div style="font-size: 14px; margin-bottom: 15px; opacity: 0.95;">
            Il est ${heure}h${minutes.toString().padStart(2, '0')}, tu n'as pas encore validÃ©:
        </div>
        ${repasListeHTML}
        <div style="font-size: 13px; margin-top: 15px; opacity: 0.9;">
            ${repasManquants.length} repas manquant${repasManquants.length > 1 ? 's' : ''}
        </div>
        <button onclick="this.parentElement.nextSibling.remove(); this.parentElement.remove();"
                style="margin-top: 20px; padding: 10px 25px; background: white; color: #ff6b6b; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">
            OK, je valide !
        </button>
    `;

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 4999;';
    overlay.onclick = () => {
        notification.remove();
        overlay.remove();
    };

    document.body.appendChild(overlay);
    document.body.appendChild(notification);
}

// ğŸ†• ALERTE OUBLI SUPPLÃ‰MENTS DU SOIR
function verifierSupplementsSoir() {
    const now = new Date();
    const heure = now.getHours();
    const minutes = now.getMinutes();
    const today = new Date().toISOString().split('T')[0];
    const lastAlertSupp = localStorage.getItem('last-suppl-alert-date');

    // Alerte Ã  22h30 si supplÃ©ments non pris
    if (heure === 22 && minutes >= 30 && minutes < 35) {
        if (lastAlertSupp === today) return; // DÃ©jÃ  alertÃ© aujourd'hui

        if (!isSupplementsSoirValides()) {
            localStorage.setItem('last-suppl-alert-date', today);
            afficherAlerteSupplementsSoir();
        }
    }
}

function afficherAlerteSupplementsSoir() {
    const menu = MENUS_BASE[jourType];
    const supplementsSoir = menu.supplementsGlobaux?.find(s => s.moment.includes('SOIR'));

    if (!supplementsSoir) return;

    // Extraire les supplÃ©ments prioritaires (ARTICULATIONS, DIABÃˆTE, RÃ‰CUPÃ‰RATION)
    const prioritaires = supplementsSoir.liste.filter(s =>
        s.includes('OmÃ©ga-3') ||
        s.includes('MagnÃ©sium') ||
        s.includes('BerbÃ©rine') ||
        s.includes('CollagÃ¨ne') ||
        s.includes('Glycine')
    );

    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 15px 50px rgba(255,107,107,0.5);
        z-index: 5000;
        max-width: 420px;
        text-align: center;
        animation: shake 0.6s;
    `;

    const now = new Date();
    const heureActuelle = `${now.getHours()}h${now.getMinutes().toString().padStart(2, '0')}`;

    notification.innerHTML = `
        <div style="font-size: 64px; margin-bottom: 15px;">ğŸ’Š</div>
        <h2 style="margin-bottom: 10px; font-size: 24px;">SupplÃ©ments du soir !</h2>
        <div style="font-size: 15px; margin-bottom: 20px; opacity: 0.95;">
            Il est ${heureActuelle}, c'est l'heure de prendre tes complÃ©ments ğŸ•
        </div>

        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; margin: 15px 0; text-align: left;">
            <div style="font-size: 14px; font-weight: bold; margin-bottom: 10px; text-align: center;">âš¡ PRIORITAIRES</div>
            ${prioritaires.map(s => `<div style="font-size: 13px; margin: 5px 0; padding-left: 10px;">â€¢ ${s}</div>`).join('')}
        </div>

        <div style="font-size: 13px; margin-top: 15px; opacity: 0.9;">
            âš ï¸ Important pour rÃ©cupÃ©ration et santÃ©
        </div>

        <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: center;">
            <button onclick="toggleSupplementsSoir(); this.parentElement.parentElement.nextSibling.remove(); this.parentElement.parentElement.remove();"
                    style="padding: 12px 25px; background: white; color: #ff6b6b; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 15px;">
                âœ… C'est pris !
            </button>
            <button onclick="this.parentElement.parentElement.nextSibling.remove(); this.parentElement.parentElement.remove();"
                    style="padding: 12px 20px; background: rgba(255,255,255,0.3); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 14px;">
                Plus tard
            </button>
        </div>
    `;

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 4999;';
    overlay.onclick = () => {
        notification.remove();
        overlay.remove();
    };

    document.body.appendChild(overlay);
    document.body.appendChild(notification);
}

// ğŸ†• RÃ‰CAP AUTOMATIQUE FIN DE JOURNÃ‰E
function verifierRecapFinJournee() {
    const now = new Date();
    const heure = now.getHours();
    const minutes = now.getMinutes();
    const today = new Date().toISOString().split('T')[0];
    const lastRecapDate = localStorage.getItem('last-recap-date');

    // RÃ©cap Ã  23h00
    if (heure === 23 && minutes >= 0 && minutes < 5) {
        if (lastRecapDate === today) return; // DÃ©jÃ  montrÃ© aujourd'hui
        localStorage.setItem('last-recap-date', today);

        afficherRecapJournee();
    }
}

function afficherRecapJournee() {
    const menu = MENUS_BASE[jourType];
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const repasValides = menu.repas.filter(r => isRepasValide(r.id));
    const repasManquants = menu.repas.filter(r => !isRepasValide(r.id));
    const today = new Date().toISOString().split('T')[0];

    // Calculer macros atteintes
    let macrosAtteintes = { P: 0, G: 0, L: 0, kcal: 0 };
    repasValides.forEach(repas => {
        macrosAtteintes.P += repas.macros.P;
        macrosAtteintes.G += repas.macros.G;
        macrosAtteintes.L += repas.macros.L;
        macrosAtteintes.kcal += repas.calories;
    });

    // Ajouter grignotages
    const grignotagesKey = `grignotages-${today}`;
    const grignotages = JSON.parse(localStorage.getItem(grignotagesKey) || '[]');
    grignotages.forEach(g => {
        macrosAtteintes.P += g.P || 0;
        macrosAtteintes.G += g.G || 0;
        macrosAtteintes.L += g.L || 0;
        macrosAtteintes.kcal += g.kcal || 0;
    });

    const macrosCibles = config.macros[jourType];
    const caloriesCible = config.calories[jourType];

    // Calculer pourcentages
    const pctP = Math.round((macrosAtteintes.P / macrosCibles.P) * 100);
    const pctG = Math.round((macrosAtteintes.G / macrosCibles.G) * 100);
    const pctL = Math.round((macrosAtteintes.L / macrosCibles.L) * 100);
    const pctCal = Math.round((macrosAtteintes.kcal / caloriesCible) * 100);

    // Score global
    const tauxValidation = Math.round((repasValides.length / menu.repas.length) * 100);
    const score = Math.round((tauxValidation + pctP + pctG + pctL + pctCal) / 5);

    // Emoji basÃ© sur le score
    let emoji = 'ğŸŒŸ';
    if (score >= 95) emoji = 'ğŸ†';
    else if (score >= 85) emoji = 'ğŸ’ª';
    else if (score >= 75) emoji = 'ğŸ‘';
    else if (score >= 60) emoji = 'ğŸ˜';
    else emoji = 'âš ï¸';

    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.4);
        z-index: 5000;
        max-width: 500px;
        text-align: center;
        animation: modalPop 0.5s;
    `;

    const repasValidesHTML = repasValides.length > 0 ? `
        <div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 10px; margin: 10px 0;">
            <div style="font-size: 14px; margin-bottom: 5px;">âœ… Repas validÃ©s (${repasValides.length}/${menu.repas.length})</div>
            ${repasValides.map(r => `<div style="font-size: 12px; opacity: 0.9;">â€¢ ${r.nom}</div>`).join('')}
        </div>
    ` : '';

    const repasManquantsHTML = repasManquants.length > 0 ? `
        <div style="background: rgba(255,107,107,0.3); padding: 10px; border-radius: 10px; margin: 10px 0;">
            <div style="font-size: 14px; margin-bottom: 5px;">âŒ Non validÃ©s (${repasManquants.length})</div>
            ${repasManquants.map(r => `<div style="font-size: 12px; opacity: 0.9;">â€¢ ${r.nom}</div>`).join('')}
        </div>
    ` : '';

    const grignotagesHTML = grignotages.length > 0 ? `
        <div style="background: rgba(255,193,7,0.3); padding: 10px; border-radius: 10px; margin: 10px 0;">
            <div style="font-size: 14px; margin-bottom: 5px;">ğŸª Grignotages (${grignotages.length})</div>
            ${grignotages.map(g => `<div style="font-size: 12px; opacity: 0.9;">â€¢ ${g.nom} (+${g.kcal} kcal)</div>`).join('')}
        </div>
    ` : '';

    notification.innerHTML = `
        <div style="font-size: 64px; margin-bottom: 15px;">${emoji}</div>
        <h2 style="margin-bottom: 5px; font-size: 26px;">RÃ©cap de ta journÃ©e</h2>
        <div style="font-size: 14px; margin-bottom: 20px; opacity: 0.9;">
            ${jourType === 'training' ? 'ğŸ‹ï¸ Jour Training' : 'ğŸ’¤ Jour Repos'} â€¢ ${semaineActuelle}
        </div>

        ${repasValidesHTML}
        ${repasManquantsHTML}
        ${grignotagesHTML}

        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; margin: 15px 0;">
            <div style="font-size: 16px; margin-bottom: 10px; font-weight: bold;">ğŸ“Š Macros atteintes</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 13px;">
                <div>
                    <div style="opacity: 0.8;">ProtÃ©ines</div>
                    <div style="font-weight: bold; font-size: 16px;">${macrosAtteintes.P}g / ${macrosCibles.P}g</div>
                    <div style="font-size: 11px; opacity: 0.7;">${pctP}%</div>
                </div>
                <div>
                    <div style="opacity: 0.8;">Glucides</div>
                    <div style="font-weight: bold; font-size: 16px;">${macrosAtteintes.G}g / ${macrosCibles.G}g</div>
                    <div style="font-size: 11px; opacity: 0.7;">${pctG}%</div>
                </div>
                <div>
                    <div style="opacity: 0.8;">Lipides</div>
                    <div style="font-weight: bold; font-size: 16px;">${macrosAtteintes.L}g / ${macrosCibles.L}g</div>
                    <div style="font-size: 11px; opacity: 0.7;">${pctL}%</div>
                </div>
                <div>
                    <div style="opacity: 0.8;">Calories</div>
                    <div style="font-weight: bold; font-size: 16px;">${macrosAtteintes.kcal} / ${caloriesCible}</div>
                    <div style="font-size: 11px; opacity: 0.7;">${pctCal}%</div>
                </div>
            </div>
        </div>

        <div style="font-size: 18px; font-weight: bold; margin: 15px 0;">
            Score: ${score}% ${emoji}
        </div>

        <button onclick="this.parentElement.nextSibling.remove(); this.parentElement.remove();"
                style="margin-top: 15px; padding: 12px 30px; background: white; color: #667eea; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; font-size: 16px;">
            Bonne nuit ! ğŸ˜´
        </button>
    `;

    const overlay = document.createElement('div');
    overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 4999;';
    overlay.onclick = () => {
        notification.remove();
        overlay.remove();
    };

    document.body.appendChild(overlay);
    document.body.appendChild(notification);
}

function verifierEtNotifierChangementSemaine() {
    const peseesSemaine = pesees.filter(p => p.semaine === semaineActuelle);
    const aujourdhui = new Date();
    const jourSemaine = aujourdhui.getDay();
    
    if ((jourSemaine === 5 || jourSemaine === 6) && peseesSemaine.length === 0) {
        const lastNotif = localStorage.getItem('derniere-notif-pesee');
        const today = new Date().toISOString().split('T')[0];
        
        if (lastNotif !== today) {
            setTimeout(() => {
                const notification = document.createElement('div');
                notification.style.cssText = 'position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); z-index: 4000; max-width: 400px; text-align: center; animation: modalPop 0.5s;';
                notification.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">âš–ï¸</div>
                    <h3 style="color: #667eea; margin-bottom: 10px;">Rappel PesÃ©e Hebdomadaire</h3>
                    <p style="color: #666; margin-bottom: 20px;">C'est le moment idÃ©al pour te peser !<br><small>Vendredi/Samedi matin, Ã  jeun, aprÃ¨s toilettes</small></p>
                    <button onclick="this.parentElement.remove(); ouvrirFormulairePesee();" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer; margin-right: 10px;">âš–ï¸ Faire ma pesÃ©e</button>
                    <button onclick="this.parentElement.remove();" style="background: #f0f0f0; color: #666; border: none; padding: 12px 24px; border-radius: 10px; font-weight: bold; cursor: pointer;">Plus tard</button>
                `;
                document.body.appendChild(notification);
                
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3999;';
                overlay.onclick = () => {
                    notification.remove();
                    overlay.remove();
                };
                document.body.appendChild(overlay);
                
                localStorage.setItem('derniere-notif-pesee', today);
            }, 2000);
        }
    }
}

// ğŸ†• Fonction semaine actuelle Ã©tendue Ã  10 semaines
function getSemaineActuelle() {
    const dateDebut = new Date(PLAN_HYBRIDE.dateDebut);
    const aujourdhui = new Date();
    const diffJours = Math.floor((aujourdhui - dateDebut) / (1000*60*60*24));
    const numSemaine = Math.floor(diffJours / 7) + 1;
    const semaine = 'S' + (numSemaine > 10 ? 10 : numSemaine < 1 ? 1 : numSemaine);
    return semaine;
}

function updateSeasonDisplay() {
    SAISON_ACTUELLE = getSaison();
    document.getElementById('season-badge').textContent = SAISON_ACTUELLE.emoji + ' ' + SAISON_ACTUELLE.nom.toUpperCase();
    document.getElementById('season-name-detail').textContent = SAISON_ACTUELLE.nom;
}

function afficherSaison() {
    const fruitsHTML = SAISON_ACTUELLE.fruits.map(f => `<span style="background: #fff9e6; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: bold;">ğŸ ${f}</span>`).join('');
    const legumesHTML = SAISON_ACTUELLE.legumes.map(l => `<span style="background: #e8f5e9; padding: 8px 12px; border-radius: 8px; font-size: 13px; font-weight: bold;">ğŸ¥¦ ${l}</span>`).join('');
    document.getElementById('fruits-saison').innerHTML = fruitsHTML;
    document.getElementById('legumes-saison').innerHTML = legumesHTML;
}

function setDayType(type) {
    jourType = type;
    const autoMode = localStorage.getItem('autoMode') !== 'false';
    const dateToday = new Date().toISOString().split('T')[0];

    if (autoMode) {
        // Mode AUTO: enregistrer comme override manuel pour aujourd'hui
        const manualOverrides = JSON.parse(localStorage.getItem('manualOverrides') || '{}');
        manualOverrides[dateToday] = type;
        localStorage.setItem('manualOverrides', JSON.stringify(manualOverrides));
        updateAutoModeIndicator(true, true); // Afficher que override actif
    } else {
        // Mode MANUEL: sauvegarder normalement
        localStorage.setItem('jourType', type);
        updateAutoModeIndicator(false, false);
    }

    document.getElementById('day-display').textContent = type === 'training' ? 'ğŸ‹ï¸ JOUR TRAINING' : 'ğŸ’¤ JOUR REPOS';

    afficherMenu();
    calculerProgression(); // ğŸ†• calculerProgression() gÃ¨re les macros custom
    showAutoSave();
}

// ğŸ†• DÃ‰TECTION AUTO JOUR TRAINING/REPOS
function detecterJourType() {
    const today = new Date();
    const dayOfWeek = today.getDay(); // 0=Dim, 1=Lun, 2=Mar, 3=Mer, 4=Jeu, 5=Ven, 6=Sam
    // Lun(1), Mer(3), Ven(5) = Training, autres = Repos
    return (dayOfWeek === 1 || dayOfWeek === 3 || dayOfWeek === 5) ? 'training' : 'repos';
}

function loadDayType() {
    const autoMode = localStorage.getItem('autoMode') !== 'false'; // Default: true
    const dateToday = new Date().toISOString().split('T')[0];

    if (autoMode) {
        // Mode AUTO: utilise dÃ©tection auto sauf si override manuel pour aujourd'hui
        const manualOverrides = JSON.parse(localStorage.getItem('manualOverrides') || '{}');
        if (manualOverrides[dateToday]) {
            jourType = manualOverrides[dateToday];
        } else {
            jourType = detecterJourType();
        }
        updateAutoModeIndicator(true, manualOverrides[dateToday] ? true : false);
    } else {
        // Mode MANUEL: utilise la valeur sauvegardÃ©e
        const saved = localStorage.getItem('jourType');
        if (saved) jourType = saved;
        updateAutoModeIndicator(false, false);
    }

    document.getElementById('day-display').textContent = jourType === 'training' ? 'ğŸ‹ï¸ JOUR TRAINING' : 'ğŸ’¤ JOUR REPOS';
}

function toggleAutoMode() {
    const currentMode = localStorage.getItem('autoMode') !== 'false';
    const newMode = !currentMode;
    localStorage.setItem('autoMode', newMode.toString());

    if (newMode) {
        // Passer en mode AUTO: effacer les overrides et recharger
        localStorage.removeItem('manualOverrides');
        loadDayType();
        afficherMenu();
        calculerProgression();
    } else {
        // Passer en mode MANUEL: sauvegarder le type actuel
        localStorage.setItem('jourType', jourType);
        updateAutoModeIndicator(false, false);
    }

    showAutoSave();
}

function updateAutoModeIndicator(isAuto, hasOverride) {
    const indicator = document.getElementById('auto-mode-indicator');
    const btnToggle = document.getElementById('btn-toggle-auto');

    if (isAuto) {
        if (hasOverride) {
            indicator.innerHTML = 'ğŸ¤– Mode AUTO <span style="color: #ff6b6b;">(Override actif aujourd\'hui)</span>';
            indicator.style.color = '#ff6b6b';
        } else {
            indicator.innerHTML = 'ğŸ¤– Mode AUTO (Lun/Mer/Ven=Training)';
            indicator.style.color = '#666';
        }
        btnToggle.innerHTML = 'ğŸ‘† Manuel';
        btnToggle.style.background = '#e3f2fd';
    } else {
        indicator.innerHTML = 'ğŸ‘† Mode MANUEL';
        indicator.style.color = '#666';
        btnToggle.innerHTML = 'ğŸ¤– Auto';
        btnToggle.style.background = '#f0f0f0';
    }
}

// ğŸ†• Fonction affichage menu MODIFIÃ‰E avec supplÃ©ments et anti-inflammatoires
function afficherMenu() {
    const menu = MENUS_BASE[jourType];
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    
    document.getElementById('semaine-actuelle-label').textContent = `${semaineActuelle} - ${config.nom.toUpperCase()}`;
    
    let html = '';
    
    menu.repas.forEach(repas => {
        const valide = isRepasValide(repas.id);
        
        html += `<div class="nutrition-section">
            <h3>${repas.heure} - ${repas.nom}</h3>
            <div class="meal">
                <div class="meal-details">
                    <div class="detail-item"><span class="detail-label">Cal:</span> ${repas.calories}</div>
                    <div class="detail-item"><span class="detail-label">P:</span> ${repas.macros.P}g</div>
                    <div class="detail-item"><span class="detail-label">G:</span> ${repas.macros.G}g</div>
                    <div class="detail-item"><span class="detail-label">L:</span> ${repas.macros.L}g</div>
                </div>`;
        
        if (repas.note) {
            html += `<div style="background: #fff9e6; padding: 8px; border-radius: 6px; margin: 8px 0; font-size: 12px;"><strong>âš ï¸</strong> ${repas.note}</div>`;
        }
        
        if (repas.options) {
            const today = new Date().toISOString().split('T')[0];
            const optionKey = `${today}-${repas.id}`;
            const optionSelectionnee = optionsSelectionnees[optionKey] || repas.options[0].id;
            
            html += `<div class="option-selector">
                <strong>ğŸ”„ Choix option :</strong><br>`;
            
            repas.options.forEach(opt => {
                const isActive = opt.id === optionSelectionnee;
                html += `<button class="option-btn ${isActive ? 'active' : ''}" onclick="selectOption('${repas.id}', '${opt.id}')">${opt.nom}</button>`;
            });
            
            html += `</div>`;
            
            const optionChoisie = repas.options.find(o => o.id === optionSelectionnee);
            
            if (optionChoisie.plat) {
                html += `<div class="meal-foods">
                    <strong>ğŸ½ï¸ PLAT PRINCIPAL:</strong>
                    <ul>${optionChoisie.plat.map(a => `<li>${a}</li>`).join('')}</ul>
                </div>`;
                
                if (optionChoisie.dessert) {
                    html += `<div class="meal-foods">
                        <strong>ğŸ¨ DESSERT (30 min aprÃ¨s):</strong>
                        <ul>${optionChoisie.dessert.map(a => `<li>${a}</li>`).join('')}</ul>
                    </div>`;
                }
            } else {
                html += `<div class="meal-foods">
                    <strong>ğŸ¥˜ Aliments:</strong>
                    <ul>${optionChoisie.aliments.map(a => `<li>${a}</li>`).join('')}</ul>
                </div>`;
            }
        } else if (repas.aliments) {
            html += `<div class="meal-foods">
                <strong>ğŸ¥˜ Aliments:</strong>
                <ul>${repas.aliments.map(a => `<li>${a}</li>`).join('')}</ul>
            </div>`;
        }
        
        // ğŸ†• Ajout supplÃ©ments associÃ©s au repas
        if (repas.supplements && repas.supplements.length > 0) {
            html += `<div class="supplements-box">
                <strong>ğŸ’Š SUPPLÃ‰MENTS Ã€ PRENDRE AVEC CE REPAS :</strong>
                <ul style="margin-left: 10px; margin-top: 5px;">${repas.supplements.map(s => `<li style="margin: 3px 0;">${s}</li>`).join('')}</ul>
            </div>`;
        }
        
        // ğŸ†• Ajout anti-inflammatoires
        if (repas.antiInflammatoires && repas.antiInflammatoires.length > 0) {
            html += `<div class="anti-inflam-box">
                <strong>ğŸŒ¿ AJOUTS ANTI-INFLAMMATOIRES :</strong>
                <ul style="margin-left: 10px; margin-top: 5px;">${repas.antiInflammatoires.map(a => `<li style="margin: 3px 0;">${a}</li>`).join('')}</ul>
            </div>`;
        }
        
        html += `<div class="validation-checkbox ${valide ? 'validated' : ''}" onclick="toggleRepas('${repas.id}')">
            <input type="checkbox" ${valide ? 'checked' : ''} onclick="event.stopPropagation()">
            <span><strong>${valide ? 'âœ… ValidÃ©' : 'â¸ï¸ Ã€ valider'}</strong></span>
        </div>
        </div>
    </div>`;
    });
    
    // ğŸ†• Ajout section supplÃ©ments globaux
    if (menu.supplementsGlobaux && menu.supplementsGlobaux.length > 0) {
        html += `<div class="nutrition-section">
            <h3>ğŸ’Š SUPPLÃ‰MENTS ${jourType === 'training' ? 'JOUR TRAINING' : 'JOUR REPOS'}</h3>`;

        menu.supplementsGlobaux.forEach((supp, suppIndex) => {
            const isSoir = supp.moment.includes('SOIR');
            const suppValide = isSoir ? isSupplementsSoirValides() : false;

            html += `<div class="meal">
                <strong style="color: #667eea; font-size: 14px;">${supp.moment}</strong>
                <div class="meal-foods">
                    <ul>${supp.liste.map(s => `<li>${s}</li>`).join('')}</ul>
                </div>`;

            // ğŸ†• Checkbox validation UNIQUEMENT pour supplÃ©ments du SOIR
            if (isSoir) {
                html += `<div class="validation-checkbox ${suppValide ? 'validated' : ''}" onclick="toggleSupplementsSoir()" style="margin-top: 15px;">
                    <input type="checkbox" ${suppValide ? 'checked' : ''} onclick="event.stopPropagation()">
                    <span><strong>${suppValide ? 'âœ… ComplÃ©ments pris' : 'âš ï¸ Ã€ prendre ce soir'}</strong></span>
                </div>`;
            }

            html += `</div>`;
        });

        html += `</div>`;
    }
    
    document.getElementById('menu-container').innerHTML = html;
}

// ğŸ†• Fonction sÃ©lection option
function selectOption(repasId, optionId) {
    const today = new Date().toISOString().split('T')[0];
    const optionKey = `${today}-${repasId}`;
    optionsSelectionnees[optionKey] = optionId;
    localStorage.setItem('options-repas', JSON.stringify(optionsSelectionnees));
    afficherMenu();
    showAutoSave();
}

function toggleRepas(repasId) {
    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    let validations = JSON.parse(localStorage.getItem(key) || '[]');
    const index = validations.indexOf(repasId);
    
    if (index > -1) {
        validations.splice(index, 1);
    } else {
        validations.push(repasId);
    }
    
    localStorage.setItem(key, JSON.stringify(validations));
    
    afficherMenu();
    calculerProgression();
    showAutoSave();
}

function isRepasValide(repasId) {
    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    const validations = JSON.parse(localStorage.getItem(key) || '[]');
    return validations.includes(repasId);
}

// ğŸ†• GESTION VALIDATION SUPPLÃ‰MENTS DU SOIR
function toggleSupplementsSoir() {
    const today = new Date().toISOString().split('T')[0];
    const key = `supplements-soir-${today}`;
    const current = localStorage.getItem(key) === 'true';
    localStorage.setItem(key, (!current).toString());
    afficherMenu();
    showAutoSave();
}

function isSupplementsSoirValides() {
    const today = new Date().toISOString().split('T')[0];
    const key = `supplements-soir-${today}`;
    return localStorage.getItem(key) === 'true';
}

function calculerProgression() {
    const menu = MENUS_BASE[jourType];
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];

    // ğŸ†• Utiliser macros custom si dÃ©finies
    const macrosCustom = JSON.parse(localStorage.getItem('macros-custom') || '{}');
    const macrosCibles = macrosCustom[semaineActuelle]?.[jourType] || config.macros[jourType];
    const caloriesCible = Math.round(macrosCibles.P * 4 + macrosCibles.G * 4 + macrosCibles.L * 9);

    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    const validations = JSON.parse(localStorage.getItem(key) || '[]');

    let totalCal = 0, totalP = 0, totalG = 0, totalL = 0;
    validations.forEach(id => {
        const repas = menu.repas.find(r => r.id === id);
        if (repas && repas.calories) {
            totalCal += repas.calories;
            totalP += repas.macros.P;
            totalG += repas.macros.G;
            totalL += repas.macros.L;
        }
    });

    const grigJour = grignotages.filter(g => g.date === today);
    const totalGrig = grigJour.reduce((sum, g) => sum + g.calories, 0);
    totalCal += totalGrig;

    document.getElementById('cal-actuel').textContent = totalCal;
    document.getElementById('prot-actuel').textContent = totalP;
    document.getElementById('gluc-actuel').textContent = totalG;
    document.getElementById('lip-actuel').textContent = totalL;

    // ğŸ†• Afficher macros cibles (custom ou par dÃ©faut)
    document.getElementById('cal-total').textContent = caloriesCible;
    document.getElementById('prot-total').textContent = macrosCibles.P;
    document.getElementById('gluc-total').textContent = macrosCibles.G;
    document.getElementById('lip-total').textContent = macrosCibles.L;

    const pct = Math.min(100, Math.round((totalCal / caloriesCible) * 100));
    document.getElementById('progress-bar').style.width = pct + '%';
    document.getElementById('progress-bar').textContent = pct + '%';
}

function afficherSemaine(num) {
    semaineActuelle = 'S' + num;
    afficherMenu();
    calculerProgression();
    afficherCarteSemaine();
    updateTimelineVisuel();
    showAutoSave();
}

// ğŸ†• Timeline Ã©tendue Ã  10 semaines
function updateTimelineVisuel() {
    const items = document.querySelectorAll('.timeline-item');
    const numActuel = parseInt(semaineActuelle.substring(1));
    
    items.forEach((item, i) => {
        const num = i + 1;
        item.classList.remove('active', 'completed', 'future');
        const pesee = pesees.find(p => p.semaine === 'S' + num);
        
        if (num < numActuel || pesee) {
            item.classList.add('completed');
        } else if (num === numActuel) {
            item.classList.add('active');
        } else {
            item.classList.add('future');
        }
    });

    const progress = ((numActuel - 1) / 9) * 90;
    document.getElementById('timeline-progress').style.width = progress + '%';
}

function afficherCarteSemaine() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const pesee = pesees.find(p => p.semaine === semaineActuelle);
    
    let html = `<div class="week-card ${config.phase}">
        <div class="week-header">
            <div class="week-title">${semaineActuelle} - ${config.nom}</div>
            <div class="phase-badge ${config.phase}">${config.phase.toUpperCase()}</div>
        </div>
        <div style="margin: 15px 0; color: #666; font-size: 14px;">
            <strong>ğŸ¯ Objectif :</strong> ${config.objectif}
        </div>
        <div class="stats-grid">
            <div class="stat-item">
                <div class="stat-label">Calories Training</div>
                <div class="stat-value">${config.calories.training}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Calories Repos</div>
                <div class="stat-value">${config.calories.repos}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">DÃ©ficit cible</div>
                <div class="stat-value">${config.deficitCible}</div>
            </div>
            <div class="stat-item">
                <div class="stat-label">Perte visÃ©e</div>
                <div class="stat-value">${config.perteVisee}kg</div>
            </div>
        </div>
        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-top: 15px;">
            <strong>ğŸ“Š Macros Training :</strong> P${config.macros.training.P}g / G${config.macros.training.G}g / L${config.macros.training.L}g<br>
            <strong>ğŸ“Š Macros Repos :</strong> P${config.macros.repos.P}g / G${config.macros.repos.G}g / L${config.macros.repos.L}g
        </div>`;
    
    if (pesee) {
        const deltaKg = pesee.deltaKg || 0;
        const deltaColor = deltaKg < 0 ? '#51cf66' : '#ff6b6b';
        html += `<div class="alert-box alert-success" style="margin-top: 15px;">
            <strong>âœ… PesÃ©e enregistrÃ©e</strong><br>
            Poids: ${pesee.poids}kg (<span style="color: ${deltaColor}">${deltaKg > 0 ? '+' : ''}${deltaKg.toFixed(1)}kg</span>)<br>
            % Graisse: ${pesee.bf}% | Tour taille: ${pesee.taille}cm<br>
            Ã‰nergie: ${pesee.energie}/10 | Digestion: ${pesee.digestion}/10
        </div>`;
    } else {
        html += `<div class="alert-box alert-warning" style="margin-top: 15px;">
            <strong>âš ï¸ PesÃ©e manquante</strong><br>
            Pense Ã  te peser ce vendredi ou samedi matin !
        </div>`;
    }
    
    html += `</div>`;
    document.getElementById('carte-semaine-actuelle').innerHTML = html;
}

function ouvrirFormulairePesee() {
    document.getElementById('input-semaine').value = semaineActuelle;
    document.getElementById('modal-pesee').classList.add('show');
}

function closeModal(id) {
    document.getElementById(id).classList.remove('show');
}

function enregistrerPesee() {
    const semaine = document.getElementById('input-semaine').value;
    const poids = parseFloat(document.getElementById('input-poids').value);
    const bf = parseFloat(document.getElementById('input-bf').value);
    const taille = parseFloat(document.getElementById('input-taille').value) || null;
    const bras = parseFloat(document.getElementById('input-bras').value) || null;
    const energie = parseInt(document.getElementById('input-energie').value) || null;
    const digestion = parseInt(document.getElementById('input-digestion').value) || null;
    const notes = document.getElementById('input-notes-pesee').value;

    if (!poids || !bf) {
        alert('âš ï¸ Poids et % graisse obligatoires !');
        return;
    }

    const existingIndex = pesees.findIndex(p => p.semaine === semaine);
    const peseePrecedente = pesees.find(p => {
        const numSem = parseInt(semaine.substring(1));
        return p.semaine === 'S' + (numSem - 1);
    });

    const masseMaigre = poids * (1 - bf / 100);
    const masseGrasse = poids * (bf / 100);
    
    const pesee = {
        semaine,
        date: new Date().toISOString().split('T')[0],
        poids,
        bf,
        masseMaigre: parseFloat(masseMaigre.toFixed(1)),
        masseGrasse: parseFloat(masseGrasse.toFixed(1)),
        taille,
        bras,
        energie,
        digestion,
        notes,
        deltaKg: peseePrecedente ? parseFloat((poids - peseePrecedente.poids).toFixed(1)) : 0,
        deltaBF: peseePrecedente ? parseFloat((bf - peseePrecedente.bf).toFixed(1)) : 0,
        deltaTaille: peseePrecedente && taille && peseePrecedente.taille ? parseFloat((taille - peseePrecedente.taille).toFixed(1)) : null
    };

    if (existingIndex > -1) {
        pesees[existingIndex] = pesee;
    } else {
        pesees.push(pesee);
    }

    pesees.sort((a, b) => {
        const numA = parseInt(a.semaine.substring(1));
        const numB = parseInt(b.semaine.substring(1));
        return numA - numB;
    });

    localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));

    document.getElementById('input-poids').value = '';
    document.getElementById('input-bf').value = '';
    document.getElementById('input-taille').value = '';
    document.getElementById('input-bras').value = '';
    document.getElementById('input-energie').value = '';
    document.getElementById('input-digestion').value = '';
    document.getElementById('input-notes-pesee').value = '';

    closeModal('modal-pesee');
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    afficherAlertes();
    updateTimelineVisuel();
    showAutoSave();
}

function afficherGraphiquePoids() {
    if (pesees.length === 0) {
        document.getElementById('svg-poids').innerHTML = '<text x="50%" y="50%" text-anchor="middle" fill="#999" font-size="14">Aucune donnÃ©e - Ajoute ta premiÃ¨re pesÃ©e !</text>';
        return;
    }

    const svg = document.getElementById('svg-poids');
    const width = svg.clientWidth || 800;
    const height = 250;
    const padding = {top: 20, right: 50, bottom: 40, left: 50};
    
    const poidsData = [{semaine: 'S0', poids: PLAN_HYBRIDE.poidsInitial}, ...pesees];
    const minPoids = Math.min(...poidsData.map(p => p.poids)) - 1;
    const maxPoids = Math.max(...poidsData.map(p => p.poids)) + 1;
    
    const xScale = (width - padding.left - padding.right) / (poidsData.length - 1);
    const yScale = (height - padding.top - padding.bottom) / (maxPoids - minPoids);
    
    let pathD = '';
    let points = '';
    
    poidsData.forEach((p, i) => {
        const x = padding.left + i * xScale;
        const y = height - padding.bottom - ((p.poids - minPoids) * yScale);
        
        if (i === 0) pathD += `M ${x} ${y}`;
        else pathD += ` L ${x} ${y}`;
        
        const color = p.semaine === semaineActuelle ? '#667eea' : '#51cf66';
        points += `<circle cx="${x}" cy="${y}" r="5" fill="${color}" stroke="white" stroke-width="2"/>`;
        points += `<text x="${x}" y="${y - 10}" text-anchor="middle" font-size="11" font-weight="bold" fill="${color}">${p.poids}kg</text>`;
    });
    
    let gridLines = '';
    for (let i = 0; i <= 4; i++) {
        const y = padding.top + (height - padding.top - padding.bottom) * i / 4;
        const valeur = (maxPoids - (maxPoids - minPoids) * i / 4).toFixed(1);
        gridLines += `<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>`;
        gridLines += `<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" font-size="10" fill="#999">${valeur}kg</text>`;
    }
    
    let xLabels = '';
    poidsData.forEach((p, i) => {
        const x = padding.left + i * xScale;
        xLabels += `<text x="${x}" y="${height - 10}" text-anchor="middle" font-size="11" fill="#666">${p.semaine}</text>`;
    });
    
    svg.innerHTML = `
        ${gridLines}
        <path d="${pathD}" fill="none" stroke="#667eea" stroke-width="3"/>
        ${points}
        ${xLabels}
        <text x="${width / 2}" y="15" text-anchor="middle" font-size="12" font-weight="bold" fill="#667eea">Ã‰volution du poids</text>
    `;
}

function afficherHistoriquePesees() {
    if (pesees.length === 0) {
        document.getElementById('historique-pesees').innerHTML = '<p style="color: #999; text-align: center;">Aucune pesÃ©e enregistrÃ©e</p>';
        return;
    }

    let html = '';
    pesees.slice().reverse().forEach(p => {
        const deltaColor = p.deltaKg < 0 ? '#51cf66' : p.deltaKg > 0 ? '#ff6b6b' : '#999';
        html += `<div class="progress-card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <div>
                    <strong style="font-size: 18px; color: #667eea;">${p.semaine}</strong>
                    <span style="color: #999; margin-left: 10px; font-size: 12px;">${new Date(p.date).toLocaleDateString('fr-FR')}</span>
                </div>
                <button class="btn btn-danger" onclick="supprimerPesee('${p.semaine}')" style="padding: 6px 12px; font-size: 11px;">Supprimer</button>
            </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">Poids</div>
                    <div class="stat-value">${p.poids}kg</div>
                    ${p.deltaKg !== 0 ? `<div style="font-size: 11px; color: ${deltaColor}; font-weight: bold;">${p.deltaKg > 0 ? '+' : ''}${p.deltaKg}kg</div>` : ''}
                </div>
                <div class="stat-item">
                    <div class="stat-label">% Graisse</div>
                    <div class="stat-value">${p.bf}%</div>
                    ${p.deltaBF !== 0 ? `<div style="font-size: 11px; color: ${p.deltaBF < 0 ? '#51cf66' : '#ff6b6b'}; font-weight: bold;">${p.deltaBF > 0 ? '+' : ''}${p.deltaBF}%</div>` : ''}
                </div>
                ${p.taille ? `<div class="stat-item">
                    <div class="stat-label">Tour taille</div>
                    <div class="stat-value">${p.taille}cm</div>
                    ${p.deltaTaille ? `<div style="font-size: 11px; color: ${p.deltaTaille < 0 ? '#51cf66' : '#ff6b6b'}; font-weight: bold;">${p.deltaTaille > 0 ? '+' : ''}${p.deltaTaille}cm</div>` : ''}
                </div>` : ''}
                <div class="stat-item">
                    <div class="stat-label">Masse maigre</div>
                    <div class="stat-value">${p.masseMaigre}kg</div>
                </div>
            </div>
            ${p.energie || p.digestion ? `<div style="background: #f8f9fa; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px;">
                ${p.energie ? `âš¡ Ã‰nergie: ${p.energie}/10 | ` : ''}
                ${p.digestion ? `ğŸŒ¿ Digestion: ${p.digestion}/10` : ''}
            </div>` : ''}
            ${p.notes ? `<div style="background: #fff9e6; padding: 10px; border-radius: 8px; margin-top: 10px; font-size: 12px;">
                <strong>ğŸ“ Notes :</strong> ${p.notes}
            </div>` : ''}
        </div>`;
    });
    document.getElementById('historique-pesees').innerHTML = html;
}

function supprimerPesee(semaine) {
    if (!confirm(`Supprimer la pesÃ©e ${semaine} ?`)) return;
    pesees = pesees.filter(p => p.semaine !== semaine);
    localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    afficherAlertes();
    updateTimelineVisuel();
    showAutoSave();
}

function afficherAlertes() {
    if (pesees.length < 2) {
        document.getElementById('alertes-container').innerHTML = '';
        return;
    }

    const dernierePesee = pesees[pesees.length - 1];
    const config = PLAN_HYBRIDE.semaines[dernierePesee.semaine];
    const deltaKg = dernierePesee.deltaKg;
    const perteVisee = config.perteVisee;
    
    let html = '<div class="progress-card"><h3 style="color: #667eea; margin-bottom: 15px;">ğŸš¨ Alertes & Recommandations</h3>';

    if (Math.abs(deltaKg - (-perteVisee)) > 0.5) {
        if (deltaKg > -0.3) {
            html += `<div class="alert-box alert-danger">
                <strong>ğŸ”´ ALERTE : Perte trop lente</strong><br>
                Perte rÃ©elle: ${deltaKg.toFixed(1)}kg | Objectif: -${perteVisee}kg<br>
                <strong>Actions :</strong><br>
                â€¢ RÃ©duire calories de 100-150 kcal/jour<br>
                â€¢ VÃ©rifier adhÃ©rence (repas validÃ©s)<br>
                â€¢ Augmenter NEAT (marche 30 min/jour)
            </div>`;
        } else if (deltaKg < -1.5) {
            html += `<div class="alert-box alert-warning">
                <strong>ğŸŸ  ATTENTION : Perte trop rapide</strong><br>
                Perte rÃ©elle: ${deltaKg.toFixed(1)}kg | Objectif: -${perteVisee}kg<br>
                <strong>Actions :</strong><br>
                â€¢ Augmenter calories de 100-150 kcal/jour<br>
                â€¢ Ajouter glucides autour training<br>
                â€¢ Surveiller masse maigre (protÃ©ines 2g/kg)
            </div>`;
        }
    } else {
        html += `<div class="alert-box alert-success">
            <strong>âœ… PROGRESSION OPTIMALE</strong><br>
            Perte rÃ©elle: ${deltaKg.toFixed(1)}kg | Objectif: -${perteVisee}kg<br>
            Continue exactement comme Ã§a ! ğŸ’ª
        </div>`;
    }

    if (dernierePesee.energie && dernierePesee.energie < 6) {
        html += `<div class="alert-box alert-warning">
            <strong>âš¡ Ã‰nergie basse (${dernierePesee.energie}/10)</strong><br>
            â€¢ Augmenter glucides prÃ©-training (+20g)<br>
            â€¢ Sommeil 8h minimum<br>
            â€¢ Envisager refeed si phase sÃ¨che
        </div>`;
    }

    const numSemaine = parseInt(dernierePesee.semaine.substring(1));
    if (numSemaine === 10) {
        html += `<div class="alert-box alert-success">
            <strong>ğŸ‰ SEMAINE 10 : BILAN FINAL</strong><br>
            FÃ©licitations pour avoir terminÃ© le programme !<br>
            Pense Ã  faire le bilan complet :<br>
            â€¢ Photos avant/aprÃ¨s<br>
            â€¢ Mensurations complÃ¨tes<br>
            â€¢ Analyses sanguines si nÃ©cessaire
        </div>`;
    }

    html += '</div>';
    document.getElementById('alertes-container').innerHTML = html;
}

function openGrignotageModal() {
    document.getElementById('modal-grignotage').classList.add('show');
}

function ajouterGrignotage() {
    const aliment = document.getElementById('input-aliment').value.trim();
    const quantite = document.getElementById('input-quantite').value;
    const calories = document.getElementById('input-calories').value;
    
    if (!aliment || !quantite || !calories) {
        alert('âš ï¸ Remplis tous les champs');
        return;
    }

    const grig = {
        id: Date.now(),
        date: new Date().toISOString().split('T')[0],
        heure: new Date().toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'}),
        aliment,
        quantite: parseInt(quantite),
        calories: parseInt(calories)
    };

    grignotages.push(grig);
    localStorage.setItem('grignotages', JSON.stringify(grignotages));

    document.getElementById('input-aliment').value = '';
    document.getElementById('input-quantite').value = '';
    document.getElementById('input-calories').value = '';

    closeModal('modal-grignotage');
    loadGrignotages();
    calculerProgression();
    showAutoSave();
}

function loadGrignotages() {
    grignotages = JSON.parse(localStorage.getItem('grignotages') || '[]');
    const today = new Date().toISOString().split('T')[0];
    const grigJour = grignotages.filter(g => g.date === today);
    
    if (grigJour.length === 0) {
        document.getElementById('liste-grignotages').innerHTML = '<p style="color: #999; text-align: center;">Aucun grignotage aujourd\'hui ğŸ‘</p>';
        document.getElementById('total-grignotages').textContent = '+0 kcal';
        return;
    }

    let html = '';
    grigJour.forEach(g => {
        html += `<div class="grignotage-item"><div><strong>${g.heure} - ${g.aliment}</strong><br><small>${g.quantite}g â€¢ ${g.calories} kcal</small></div><button class="btn btn-danger" onclick="supprimerGrignotage(${g.id})">Ã—</button></div>`;
    });
    document.getElementById('liste-grignotages').innerHTML = html;

    const total = grigJour.reduce((sum, g) => sum + g.calories, 0);
    const color = total > 500 ? '#ff6b6b' : total > 300 ? '#ffc107' : '#51cf66';
    document.getElementById('total-grignotages').innerHTML = `<span style="color: ${color}">+${total} kcal</span>`;
}

function supprimerGrignotage(id) {
    if (!confirm('Supprimer ce grignotage ?')) return;
    grignotages = grignotages.filter(g => g.id !== id);
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    loadGrignotages();
    calculerProgression();
    showAutoSave();
}

function exportRapport() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const menu = MENUS_BASE[jourType];
    const today = new Date().toISOString().split('T')[0];
    const key = `repas-${today}`;
    const validations = JSON.parse(localStorage.getItem(key) || '[]');
    const grigJour = grignotages.filter(g => g.date === today);
    
    let totalCal = 0, totalP = 0, totalG = 0, totalL = 0;
    validations.forEach(id => {
        const repas = menu.repas.find(r => r.id === id);
        if (repas && repas.calories) {
            totalCal += repas.calories;
            totalP += repas.macros.P;
            totalG += repas.macros.G;
            totalL += repas.macros.L;
        }
    });

    const totalGrig = grigJour.reduce((sum, g) => sum + g.calories, 0);
    totalCal += totalGrig;

    let rapport = `ğŸ”¥ RAPPORT PLAN SÃˆCHE - ${today}\n`;
    rapport += `${semaineActuelle} - ${config.nom} (${config.phase.toUpperCase()})\n`;
    rapport += `${jourType === 'training' ? 'ğŸ‹ï¸ JOUR TRAINING' : 'ğŸ’¤ JOUR REPOS'}\n`;
    rapport += `${SAISON_ACTUELLE.emoji} Saison: ${SAISON_ACTUELLE.nom}\n\n`;
    
    rapport += `ğŸ¯ OBJECTIFS SEMAINE\n`;
    rapport += `Calories: ${config.calories[jourType]} kcal | DÃ©ficit: ${config.deficitCible} kcal\n`;
    rapport += `Perte visÃ©e: -${config.perteVisee}kg\n`;
    rapport += `Macros: P${config.macros[jourType].P}g / G${config.macros[jourType].G}g / L${config.macros[jourType].L}g\n\n`;
    
    rapport += `âœ… RÃ‰ALISATIONS JOUR\n`;
    rapport += `Calories: ${totalCal} kcal (${Math.round((totalCal / config.calories[jourType]) * 100)}%)\n`;
    rapport += `ProtÃ©ines: ${totalP}g | Glucides: ${totalG}g | Lipides: ${totalL}g\n`;
    rapport += `Repas validÃ©s: ${validations.length}/${menu.repas.length}\n\n`;
    
    if (grigJour.length > 0) {
        rapport += `ğŸª GRIGNOTAGES (+${totalGrig} kcal)\n`;
        grigJour.forEach(g => rapport += `${g.heure} - ${g.aliment} ${g.quantite}g (+${g.calories} kcal)\n`);
        rapport += `\n`;
    }

    rapport += `ğŸ“ NOTES\n${document.getElementById('notes-jour')?.value || '(Aucune note)'}\n\n`;
    
    rapport += `ğŸ“Š PROGRESSION PROGRAMME\n`;
    rapport += `Semaine actuelle: ${semaineActuelle}/S10\n`;
    rapport += `PesÃ©es enregistrÃ©es: ${pesees.length}/10\n`;
    if (pesees.length > 0) {
        const dernierePesee = pesees[pesees.length - 1];
        rapport += `Dernier poids: ${dernierePesee.poids}kg (${dernierePesee.bf}%)\n`;
        rapport += `Ã‰volution: ${dernierePesee.deltaKg > 0 ? '+' : ''}${dernierePesee.deltaKg}kg\n`;
    }

    navigator.clipboard.writeText(rapport).then(() => alert('âœ… Rapport copiÃ© !')).catch(() => alert('âŒ Erreur copie'));
}

function exportRapportSemaine() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const pesee = pesees.find(p => p.semaine === semaineActuelle);
    
    let rapport = `ğŸ“Š RAPPORT ${semaineActuelle} - ${config.nom}\n`;
    rapport += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n\n`;
    rapport += `ğŸ¯ OBJECTIFS\n`;
    rapport += `Phase: ${config.phase.toUpperCase()}\n`;
    rapport += `Objectif: ${config.objectif}\n`;
    rapport += `Calories Training: ${config.calories.training} kcal\n`;
    rapport += `Calories Repos: ${config.calories.repos} kcal\n`;
    rapport += `DÃ©ficit cible: ${config.deficitCible} kcal/jour\n`;
    rapport += `Perte visÃ©e: -${config.perteVisee}kg\n\n`;
    
    if (pesee) {
        rapport += `âš–ï¸ RÃ‰SULTATS\n`;
        rapport += `Poids: ${pesee.poids}kg (${pesee.deltaKg > 0 ? '+' : ''}${pesee.deltaKg}kg)\n`;
        rapport += `% Graisse: ${pesee.bf}% (${pesee.deltaBF > 0 ? '+' : ''}${pesee.deltaBF}%)\n`;
        rapport += `Masse maigre: ${pesee.masseMaigre}kg\n`;
        rapport += `Masse grasse: ${pesee.masseGrasse}kg\n`;
        if (pesee.taille) rapport += `Tour taille: ${pesee.taille}cm${pesee.deltaTaille ? ` (${pesee.deltaTaille > 0 ? '+' : ''}${pesee.deltaTaille}cm)` : ''}\n`;
        rapport += `\n`;
        
        const ecart = pesee.deltaKg - (-config.perteVisee);
        if (Math.abs(ecart) > 0.5) {
            rapport += `âš ï¸ ANALYSE\n`;
            if (ecart > 0.5) {
                rapport += `Perte insuffisante (${Math.abs(ecart).toFixed(1)}kg de moins que prÃ©vu)\n`;
                rapport += `â†’ RÃ©duire calories 100-150 kcal\n`;
                rapport += `â†’ VÃ©rifier adhÃ©rence nutrition\n`;
            } else {
                rapport += `Perte excessive (${Math.abs(ecart).toFixed(1)}kg de plus que prÃ©vu)\n`;
                rapport += `â†’ Augmenter calories 100-150 kcal\n`;
                rapport += `â†’ Surveiller masse maigre\n`;
            }
            rapport += `\n`;
        }
        
        if (pesee.notes) {
            rapport += `ğŸ“ NOTES\n${pesee.notes}\n\n`;
        }
    } else {
        rapport += `âš ï¸ PESÃ‰E NON EFFECTUÃ‰E\n`;
        rapport += `Penser Ã  se peser ce vendredi/samedi !\n\n`;
    }

    navigator.clipboard.writeText(rapport).then(() => alert('âœ… Rapport semaine copiÃ© !')).catch(() => alert('âŒ Erreur copie'));
}

function resetJour() {
    if (!confirm('âš ï¸ RÃ©initialiser toutes les donnÃ©es d\'aujourd\'hui ?')) return;
    const today = new Date().toISOString().split('T')[0];
    localStorage.removeItem(`repas-${today}`);
    grignotages = grignotages.filter(g => g.date !== today);
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    alert('âœ… JournÃ©e rÃ©initialisÃ©e');
}

function resetSemaine() {
    if (!confirm(`âš ï¸ Effacer TOUTES les donnÃ©es de ${semaineActuelle} ?`)) return;
    
    const dateDebut = new Date(PLAN_HYBRIDE.dateDebut);
    const numSemaine = parseInt(semaineActuelle.substring(1));
    const debutSemaine = new Date(dateDebut);
    debutSemaine.setDate(dateDebut.getDate() + ((numSemaine - 1) * 7));
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(debutSemaine);
        date.setDate(debutSemaine.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        localStorage.removeItem(`repas-${dateStr}`);
    }
    
    grignotages = grignotages.filter(g => {
        const gDate = new Date(g.date);
        return gDate < debutSemaine || gDate >= new Date(debutSemaine.getTime() + 7 * 24 * 60 * 60 * 1000);
    });
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    
    pesees = pesees.filter(p => p.semaine !== semaineActuelle);
    localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
    
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    updateTimelineVisuel();
    
    alert('âœ… Semaine rÃ©initialisÃ©e');
}

function resetTout() {
    if (!confirm('ğŸ—‘ï¸ ATTENTION : Effacer TOUTES les donnÃ©es ?')) return;
    if (!confirm('âš ï¸ DERNIÃˆRE CONFIRMATION\n\nVous allez perdre 100% de vos donnÃ©es.\n\nContinuer ?')) return;
    
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('repas-') || key === 'grignotages' || key === 'pesees-hebdo' || key === 'jourType' || key === 'options-repas') {
            keysToRemove.push(key);
        }
    }
    
    keysToRemove.forEach(key => localStorage.removeItem(key));
    
    location.reload();
}

function telechargerBackup() {
    const backup = {
        version: '5.0-seche-10sem',
        dateExport: new Date().toISOString(),
        dateDebut: PLAN_HYBRIDE.dateDebut,
        poidsInitial: PLAN_HYBRIDE.poidsInitial,
        tailleInitiale: PLAN_HYBRIDE.tailleInitiale,
        semaineActuelle: semaineActuelle,
        jourType: jourType,
        repasValidations: {},
        grignotages: grignotages,
        pesees: pesees,
        optionsSelectionnees: optionsSelectionnees
    };
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('repas-')) {
            const date = key.replace('repas-', '');
            backup.repasValidations[date] = JSON.parse(localStorage.getItem(key));
        }
    }
    
    const nbJours = Object.keys(backup.repasValidations).length;
    const nbPesees = backup.pesees.length;
    const nbGrignotages = backup.grignotages.length;
    
    backup.stats = {nbJours, nbPesees, nbGrignotages};
    
    const jsonString = JSON.stringify(backup, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-seche-10sem-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    localStorage.setItem('last-backup', new Date().toISOString());
    updateLastBackupDate();
    
    alert(`âœ… Backup tÃ©lÃ©chargÃ© !\n\nğŸ“Š Contenu :\n- ${nbJours} jours de donnÃ©es\n- ${nbPesees} pesÃ©es\n- ${nbGrignotages} grignotages`);
}

function restaurerBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!confirm('ğŸ“¥ Restaurer ce backup ?\n\nâš ï¸ Cela va REMPLACER toutes tes donnÃ©es actuelles !')) {
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            PLAN_HYBRIDE.dateDebut = backup.dateDebut;
            PLAN_HYBRIDE.poidsInitial = backup.poidsInitial;
            PLAN_HYBRIDE.tailleInitiale = backup.tailleInitiale;
            
            Object.entries(backup.repasValidations).forEach(([date, validations]) => {
                localStorage.setItem(`repas-${date}`, JSON.stringify(validations));
            });
            
            grignotages = backup.grignotages || [];
            localStorage.setItem('grignotages', JSON.stringify(grignotages));
            
            pesees = backup.pesees || [];
            localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
            
            if (backup.optionsSelectionnees) {
                optionsSelectionnees = backup.optionsSelectionnees;
                localStorage.setItem('options-repas', JSON.stringify(optionsSelectionnees));
            }
            
            if (backup.jourType) {
                jourType = backup.jourType;
                localStorage.setItem('jourType', jourType);
            }
            
            alert(`âœ… Backup restaurÃ© !\n\nğŸ“Š DonnÃ©es importÃ©es :\n- ${backup.stats?.nbJours || 0} jours\n- ${backup.stats?.nbPesees || 0} pesÃ©es\n- ${backup.stats?.nbGrignotages || 0} grignotages`);
            
            location.reload();
            
        } catch (error) {
            alert('âŒ Erreur lors de la restauration !');
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

function updateLastBackupDate() {
    const lastBackup = localStorage.getItem('last-backup');
    if (lastBackup) {
        const date = new Date(lastBackup);
        const formatted = date.toLocaleDateString('fr-FR') + ' Ã  ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('last-backup-date').textContent = formatted;
    }
}

window.addEventListener('load', updateLastBackupDate);

function showAutoSave() {
    const indicator = document.getElementById('auto-save-indicator');
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 2000);
}

// ğŸ†• FONCTION AFFICHAGE ONGLETS MODIFIÃ‰E
function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');

    if (tabName === 'suivi10sem') {
        afficherCarteSemaine();
        afficherGraphiquePoids();
        afficherHistoriquePesees();
        afficherAlertes();
    }
    if (tabName === 'saison') afficherSaison();

    // ğŸ†• Nouveaux onglets
    if (tabName === 'supplements') afficherStackSupplements();
    if (tabName === 'ajustements') {
        afficherModulationMacros();
        afficherOptionsRattrapage();
        afficherAjustementsMacros();
    }
}

// ğŸ†• FONCTION AFFICHAGE STACK 10 SUPPLÃ‰MENTS
function afficherStackSupplements() {
    const stack = STACK_SUPPLEMENTS_COMPLET;
    let html = '';

    // Matin Ã  jeun
    html += `<div class="week-card" style="border-left-color: #ffa500;">
        <h3 style="color: #ffa500;">â˜€ï¸ ${stack.matin_jeun.titre} (${stack.matin_jeun.horaire})</h3>
        <div style="display: grid; gap: 10px; margin-top: 15px;">`;
    stack.matin_jeun.supplements.forEach(supp => {
        html += `<div style="background: #fff3cd; padding: 12px; border-radius: 8px; border-left: 4px solid #ffa500;">
            <strong>âœ… ${supp.nom}</strong> : ${supp.dose} (${supp.quantite})<br>
            <small>ğŸ©¸ ${supp.diabete}</small>
        </div>`;
    });
    html += '</div></div>';

    // Repas 1
    html += `<div class="week-card" style="border-left-color: #667eea;">
        <h3 style="color: #667eea;">ğŸ½ï¸ ${stack.repas_1.titre}</h3>
        <div style="display: grid; gap: 10px; margin-top: 15px;">`;
    stack.repas_1.supplements.forEach(supp => {
        html += `<div style="background: #f0f4ff; padding: 12px; border-radius: 8px; border-left: 4px solid #667eea;">
            <strong>âœ… ${supp.nom}</strong> : ${supp.dose} (${supp.quantite})<br>
            <small>ğŸ©¸ ${supp.diabete}</small>
            ${supp.effet ? `<br><small>âœ¨ ${supp.effet}</small>` : ''}
        </div>`;
    });
    html += '</div></div>';

    // Soir
    html += `<div class="week-card" style="border-left-color: #764ba2;">
        <h3 style="color: #764ba2;">ğŸŒ™ ${stack.soir.titre}</h3>
        <div style="display: grid; gap: 10px; margin-top: 15px;">`;
    stack.soir.supplements.forEach(supp => {
        html += `<div style="background: #f3e5f5; padding: 12px; border-radius: 8px; border-left: 4px solid #764ba2;">
            <strong>âœ… ${supp.nom}</strong> : ${supp.dose} (${supp.quantite})<br>
            <small>ğŸ©¸ ${supp.diabete}</small>
            ${supp.effet ? `<br><small>âœ¨ ${supp.effet}</small>` : ''}
        </div>`;
    });
    html += '</div></div>';

    // Pendant journÃ©e
    html += `<div class="week-card" style="border-left-color: #51cf66;">
        <h3 style="color: #51cf66;">â° ${stack.journee.titre} (${stack.journee.horaire})</h3>
        <div style="display: grid; gap: 10px; margin-top: 15px;">`;
    stack.journee.supplements.forEach(supp => {
        html += `<div style="background: #e8f5e9; padding: 12px; border-radius: 8px; border-left: 4px solid #51cf66;">
            <strong>âœ… ${supp.nom}</strong> : ${supp.dose} (${supp.quantite})<br>
            <small>ğŸ©¸ ${supp.diabete}</small>
        </div>`;
    });
    html += '</div></div>';

    document.getElementById('stack-basique-container').innerHTML = html;
    document.getElementById('stack-diabete-container').innerHTML = '';
    document.getElementById('stack-cholesterol-container').innerHTML = '';
}

// ğŸ†• FONCTION MODULATION MACROS PAR SEMAINE
function afficherModulationMacros() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const macrosCustom = JSON.parse(localStorage.getItem('macros-custom') || '{}');
    const macrosSemaine = macrosCustom[semaineActuelle] || config.macros;

    let html = `
        <div style="background: #f8f9ff; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <strong style="color: #667eea;">ğŸ‹ï¸ JOUR TRAINING</strong>
                    ${creerInputsMacros('training', macrosSemaine.training, config.calories.training)}
                </div>
                <div>
                    <strong style="color: #667eea;">ğŸ’¤ JOUR REPOS</strong>
                    ${creerInputsMacros('repos', macrosSemaine.repos, config.calories.repos)}
                </div>
            </div>
            <div style="display: flex; gap: 10px; justify-content: center;">
                <button onclick="sauvegarderMacrosCustom()" class="btn btn-primary" style="padding: 10px 20px;">
                    ğŸ’¾ Sauvegarder les macros
                </button>
                <button onclick="reinitialiserMacros()" class="btn btn-secondary" style="padding: 10px 20px;">
                    ğŸ”„ RÃ©initialiser
                </button>
            </div>
        </div>
    `;

    document.getElementById('modulation-macros-container').innerHTML = html;
}

function creerInputsMacros(typeJour, macros, calories) {
    return `
        <div style="background: white; padding: 12px; border-radius: 8px; margin-top: 8px;">
            <div style="margin-bottom: 10px;">
                <label style="font-size: 12px; color: #666;">ProtÃ©ines (g)</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button onclick="ajusterMacro('${typeJour}', 'P', -5)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer;">-5</button>
                    <input type="number" id="macro-${typeJour}-P" value="${macros.P}"
                           style="width: 70px; padding: 8px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-weight: bold;" />
                    <button onclick="ajusterMacro('${typeJour}', 'P', 5)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer;">+5</button>
                </div>
            </div>
            <div style="margin-bottom: 10px;">
                <label style="font-size: 12px; color: #666;">Glucides (g)</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button onclick="ajusterMacro('${typeJour}', 'G', -10)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer;">-10</button>
                    <input type="number" id="macro-${typeJour}-G" value="${macros.G}"
                           style="width: 70px; padding: 8px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-weight: bold;" />
                    <button onclick="ajusterMacro('${typeJour}', 'G', 10)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer;">+10</button>
                </div>
            </div>
            <div style="margin-bottom: 10px;">
                <label style="font-size: 12px; color: #666;">Lipides (g)</label>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <button onclick="ajusterMacro('${typeJour}', 'L', -5)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer;">-5</button>
                    <input type="number" id="macro-${typeJour}-L" value="${macros.L}"
                           style="width: 70px; padding: 8px; border: 2px solid #667eea; border-radius: 8px; text-align: center; font-weight: bold;" />
                    <button onclick="ajusterMacro('${typeJour}', 'L', 5)" style="padding: 5px 10px; background: #f0f0f0; border: none; border-radius: 5px; cursor: pointer;">+5</button>
                </div>
            </div>
            <div style="font-size: 13px; color: #999; margin-top: 10px;">
                ğŸ“Š Calories estimÃ©es : <strong>${calories} kcal</strong>
            </div>
        </div>
    `;
}

function ajusterMacro(typeJour, macro, delta) {
    const input = document.getElementById(`macro-${typeJour}-${macro}`);
    const newValue = parseInt(input.value) + delta;
    if (newValue >= 0) {
        input.value = newValue;
    }
}

function sauvegarderMacrosCustom() {
    const macrosCustom = JSON.parse(localStorage.getItem('macros-custom') || '{}');

    macrosCustom[semaineActuelle] = {
        training: {
            P: parseInt(document.getElementById('macro-training-P').value),
            G: parseInt(document.getElementById('macro-training-G').value),
            L: parseInt(document.getElementById('macro-training-L').value)
        },
        repos: {
            P: parseInt(document.getElementById('macro-repos-P').value),
            G: parseInt(document.getElementById('macro-repos-G').value),
            L: parseInt(document.getElementById('macro-repos-L').value)
        }
    };

    localStorage.setItem('macros-custom', JSON.stringify(macrosCustom));

    // Recalculer les calories
    const calTraining = Math.round(macrosCustom[semaineActuelle].training.P * 4 + macrosCustom[semaineActuelle].training.G * 4 + macrosCustom[semaineActuelle].training.L * 9);
    const calRepos = Math.round(macrosCustom[semaineActuelle].repos.P * 4 + macrosCustom[semaineActuelle].repos.G * 4 + macrosCustom[semaineActuelle].repos.L * 9);

    alert(`âœ… Macros sauvegardÃ©es pour ${semaineActuelle} !\n\nTraining: P${macrosCustom[semaineActuelle].training.P} G${macrosCustom[semaineActuelle].training.G} L${macrosCustom[semaineActuelle].training.L} â‰ˆ ${calTraining} kcal\nRepos: P${macrosCustom[semaineActuelle].repos.P} G${macrosCustom[semaineActuelle].repos.G} L${macrosCustom[semaineActuelle].repos.L} â‰ˆ ${calRepos} kcal`);

    afficherModulationMacros();
    afficherMenu();
    calculerProgression();
}

function reinitialiserMacros() {
    const macrosCustom = JSON.parse(localStorage.getItem('macros-custom') || '{}');
    delete macrosCustom[semaineActuelle];
    localStorage.setItem('macros-custom', JSON.stringify(macrosCustom));
    alert(`ğŸ”„ Macros rÃ©initialisÃ©es pour ${semaineActuelle}`);
    afficherModulationMacros();
    afficherMenu();
    calculerProgression();
}

// ğŸ†• FONCTION OPTIONS RATTRAPAGE
function afficherOptionsRattrapage() {
    const options = JSON.parse(localStorage.getItem('options-rattrapage') || '{}');

    const optionsList = [
        {
            id: 'deficit-augmente',
            nom: 'ğŸ“‰ Augmenter le dÃ©ficit (-200 kcal)',
            description: 'RÃ©duit les glucides de 50g pour compenser le retard'
        },
        {
            id: 'carb-cycling',
            nom: 'ğŸ”„ Carb cycling strict',
            description: 'Alterne jours bas/hauts en glucides (Training+50g, Repos-50g)'
        },
        {
            id: 'week-deload-skip',
            nom: 'â­ï¸ Sauter le deload S5',
            description: 'Continue la sÃ¨che en S5 au lieu de deload si retard >1kg'
        },
        {
            id: 'training-extra',
            nom: 'ğŸƒ Cardio lÃ©ger 3Ã—/sem',
            description: '20min marche rapide les jours repos (-100 kcal/session)'
        }
    ];

    let html = '';
    optionsList.forEach(opt => {
        const checked = options[opt.id] || false;
        html += `
            <div style="background: ${checked ? '#e8f5e9' : 'white'}; border: 2px solid ${checked ? '#4caf50' : '#ddd'}; padding: 15px; border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;"
                 onclick="toggleOptionRattrapage('${opt.id}')">
                <label style="display: flex; align-items: start; cursor: pointer;">
                    <input type="checkbox" ${checked ? 'checked' : ''} onclick="event.stopPropagation();"
                           style="margin-right: 12px; width: 20px; height: 20px; margin-top: 2px;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 5px;">${opt.nom}</div>
                        <div style="font-size: 12px; color: #666;">${opt.description}</div>
                    </div>
                </label>
            </div>
        `;
    });

    html += `
        <div style="margin-top: 15px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 13px;">
            ğŸ’¡ <strong>Astuce :</strong> Active une ou plusieurs options si ta perte de poids stagne >2 semaines
        </div>
    `;

    document.getElementById('rattrapage-options-container').innerHTML = html;
}

function toggleOptionRattrapage(optionId) {
    const options = JSON.parse(localStorage.getItem('options-rattrapage') || '{}');
    options[optionId] = !options[optionId];
    localStorage.setItem('options-rattrapage', JSON.stringify(options));
    afficherOptionsRattrapage();
    showAutoSave();
}

// ğŸ†• FONCTION AFFICHAGE AJUSTEMENTS MACROS
function afficherAjustementsMacros() {
    const ajust = AJUSTEMENTS_MACROS.training;
    const details = DETAILS_NUTRITIONNELS;

    let html = '';

    // Option A
    html += `<div class="week-card moderee">
        <div class="week-header">
            <div class="week-title">${ajust.optionA.nom}</div>
            <div class="phase-badge moderee">âœ… RECOMMANDÃ‰</div>
        </div>
        <p style="color: #666; margin: 10px 0;">${ajust.optionA.description}</p>`;

    ['repas1', 'repas2', 'repas3'].forEach(repas => {
        const r = ajust.optionA[repas];
        html += `<div class="meal" style="margin: 10px 0;">
            <strong style="color: #667eea;">${repas.toUpperCase()}</strong>
            <div class="meal-foods">
                <ul>${r.modifications.map(m => `<li>${m}</li>`).join('')}</ul>
            </div>
            <div style="background: #f0f4ff; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 12px;">
                P: ${r.macros.P}g | G: ${r.macros.G}g | L: ${r.macros.L}g | ${r.macros.kcal} kcal
            </div>
        </div>`;
    });

    html += `<div class="stats-grid" style="margin-top: 15px;">
        <div class="stat-item"><div class="stat-label">ProtÃ©ines</div><div class="stat-value">${ajust.optionA.total.P}g</div></div>
        <div class="stat-item"><div class="stat-label">Glucides</div><div class="stat-value">${ajust.optionA.total.G}g</div></div>
        <div class="stat-item"><div class="stat-label">Lipides</div><div class="stat-value">${ajust.optionA.total.L}g</div></div>
        <div class="stat-item"><div class="stat-label">Calories</div><div class="stat-value">${ajust.optionA.total.kcal}</div></div>
    </div>
    <div class="alert-box alert-success" style="margin-top: 15px;">${ajust.optionA.note}</div>
    </div>`;

    // Option B
    html += `<div class="week-card agressive">
        <div class="week-header">
            <div class="week-title">${ajust.optionB.nom}</div>
            <div class="phase-badge agressive">âš ï¸ STRICT</div>
        </div>
        <p style="color: #666; margin: 10px 0;">${ajust.optionB.description}</p>`;

    ['repas1', 'repas2', 'repas3'].forEach(repas => {
        const r = ajust.optionB[repas];
        html += `<div class="meal" style="margin: 10px 0;">
            <strong style="color: #ff6b6b;">${repas.toUpperCase()}</strong>
            <div class="meal-foods">
                <ul>${r.modifications.map(m => `<li>${m}</li>`).join('')}</ul>
            </div>
            <div style="background: #ffebee; padding: 8px; border-radius: 6px; margin-top: 8px; font-size: 12px;">
                P: ${r.macros.P}g | G: ${r.macros.G}g | L: ${r.macros.L}g | ${r.macros.kcal} kcal
            </div>
        </div>`;
    });

    html += `<div class="stats-grid" style="margin-top: 15px;">
        <div class="stat-item"><div class="stat-label">ProtÃ©ines</div><div class="stat-value">${ajust.optionB.total.P}g</div></div>
        <div class="stat-item"><div class="stat-label">Glucides</div><div class="stat-value">${ajust.optionB.total.G}g</div></div>
        <div class="stat-item"><div class="stat-label">Lipides</div><div class="stat-value">${ajust.optionB.total.L}g</div></div>
        <div class="stat-item"><div class="stat-label">Calories</div><div class="stat-value">${ajust.optionB.total.kcal}</div></div>
    </div>
    <div class="alert-box alert-warning" style="margin-top: 15px;">${ajust.optionB.note}</div>
    </div>`;

    document.getElementById('ajustements-container').innerHTML = html;

    // DÃ©tails nutritionnels
    let htmlDetails = `<div class="info-box"><strong>ğŸ’¡ Astuce :</strong> Ces dÃ©tails montrent les macros PRÃ‰CISES de chaque aliment pour t'aider Ã  ajuster tes portions si besoin.</div>`;

    htmlDetails += '<h4 style="margin-top: 15px; color: #667eea;">ğŸ‹ï¸ Jours TRAINING</h4>';

    ['repas1', 'repas2', 'repas3', 'repas3_vendredi'].forEach(repas => {
        const r = details.training[repas];
        if (!r) return;

        htmlDetails += `<div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin: 10px 0;">
            <strong>${repas.toUpperCase()}</strong> - ğŸ’° ${r.cout}<br>
            <small style="color: #667eea; font-weight: bold;">Total: P${r.total.P}g | G${r.total.G}g | L${r.total.L}g | ${r.total.kcal} kcal</small>
            <div style="margin-top: 8px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 5px;">`;

        Object.entries(r.aliments).forEach(([nom, macros]) => {
            htmlDetails += `<div style="background: white; padding: 6px; border-radius: 4px; font-size: 11px;">
                <strong>${nom.replace(/_/g, ' ')}</strong><br>
                P:${macros.P}g G:${macros.G}g L:${macros.L}g | ${macros.kcal}kcal
            </div>`;
        });

        htmlDetails += '</div>';
        if (r.note) htmlDetails += `<div style="background: #fff9e6; padding: 6px; border-radius: 4px; margin-top: 5px; font-size: 11px;">${r.note}</div>`;
        htmlDetails += '</div>';
    });

    document.getElementById('details-nutritionnels-container').innerHTML = htmlDetails;
}
    </script>
</body>
</html>
