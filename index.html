rapport += `√âvolution: ${dernierePesee.deltaKg > 0 ? '+' : ''}${dernierePesee.deltaKg}kg\n`;
    }

    navigator.clipboard.writeText(rapport).then(() => alert('‚úÖ Rapport copi√© !')).catch(() => alert('‚ùå Erreur copie'));
}

function exportRapportSemaine() {
    const config = PLAN_HYBRIDE.semaines[semaineActuelle];
    const pesee = pesees.find(p => p.semaine === semaineActuelle);
    
    let rapport = `üìä RAPPORT ${semaineActuelle} - ${config.nom}\n`;
    rapport += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    rapport += `üéØ OBJECTIFS\n`;
    rapport += `Phase: ${config.phase.toUpperCase()}\n`;
    rapport += `Objectif: ${config.objectif}\n`;
    rapport += `Calories Training: ${config.calories.training} kcal\n`;
    rapport += `Calories Repos: ${config.calories.repos} kcal\n`;
    rapport += `D√©ficit cible: ${config.deficitCible} kcal/jour\n`;
    rapport += `Perte vis√©e: -${config.perteVisee}kg\n\n`;
    
    if (pesee) {
        rapport += `‚öñÔ∏è R√âSULTATS\n`;
        rapport += `Poids: ${pesee.poids}kg (${pesee.deltaKg > 0 ? '+' : ''}${pesee.deltaKg}kg)\n`;
        rapport += `% Graisse: ${pesee.bf}% (${pesee.deltaBF > 0 ? '+' : ''}${pesee.deltaBF}%)\n`;
        rapport += `Masse maigre: ${pesee.masseMaigre}kg\n`;
        rapport += `Masse grasse: ${pesee.masseGrasse}kg\n`;
        if (pesee.taille) rapport += `Tour taille: ${pesee.taille}cm${pesee.deltaTaille ? ` (${pesee.deltaTaille > 0 ? '+' : ''}${pesee.deltaTaille}cm)` : ''}\n`;
        rapport += `\n`;
        
        const ecart = pesee.deltaKg - (-config.perteVisee);
        if (Math.abs(ecart) > 0.5) {
            rapport += `‚ö†Ô∏è ANALYSE\n`;
            if (ecart > 0.5) {
                rapport += `Perte insuffisante (${Math.abs(ecart).toFixed(1)}kg de moins que pr√©vu)\n`;
                rapport += `‚Üí R√©duire calories 100-150 kcal\n`;
                rapport += `‚Üí V√©rifier adh√©rence nutrition\n`;
            } else {
                rapport += `Perte excessive (${Math.abs(ecart).toFixed(1)}kg de plus que pr√©vu)\n`;
                rapport += `‚Üí Augmenter calories 100-150 kcal\n`;
                rapport += `‚Üí Surveiller masse maigre\n`;
            }
            rapport += `\n`;
        }
        
        if (pesee.notes) {
            rapport += `üìù NOTES\n${pesee.notes}\n\n`;
        }
    } else {
        rapport += `‚ö†Ô∏è PES√âE NON EFFECTU√âE\n`;
        rapport += `Penser √† se peser ce vendredi/samedi !\n\n`;
    }

    navigator.clipboard.writeText(rapport).then(() => alert('‚úÖ Rapport semaine copi√© !')).catch(() => alert('‚ùå Erreur copie'));
}

function resetJour() {
    if (!confirm('‚ö†Ô∏è R√©initialiser toutes les donn√©es d\'aujourd\'hui ?')) return;
    const today = new Date().toISOString().split('T')[0];
    localStorage.removeItem(`repas-${today}`);
    grignotages = grignotages.filter(g => g.date !== today);
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    alert('‚úÖ Journ√©e r√©initialis√©e');
}

function resetSemaine() {
    if (!confirm(`‚ö†Ô∏è Effacer TOUTES les donn√©es de ${semaineActuelle} ?`)) return;
    
    const dateDebut = new Date(PLAN_HYBRIDE.dateDebut);
    const numSemaine = parseInt(semaineActuelle.substring(1));
    const debutSemaine = new Date(dateDebut);
    debutSemaine.setDate(dateDebut.getDate() + ((numSemaine - 1) * 7));
    
    for (let i = 0; i < 7; i++) {
        const date = new Date(debutSemaine);
        date.setDate(debutSemaine.getDate() + i);
        const dateStr = date.toISOString().split('T')[0];
        localStorage.removeItem(`repas-${dateStr}`);
    }
    
    grignotages = grignotages.filter(g => {
        const gDate = new Date(g.date);
        return gDate < debutSemaine || gDate >= new Date(debutSemaine.getTime() + 7 * 24 * 60 * 60 * 1000);
    });
    localStorage.setItem('grignotages', JSON.stringify(grignotages));
    
    pesees = pesees.filter(p => p.semaine !== semaineActuelle);
    localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
    
    afficherMenu();
    loadGrignotages();
    calculerProgression();
    afficherCarteSemaine();
    afficherGraphiquePoids();
    afficherHistoriquePesees();
    updateTimelineVisuel();
    
    alert('‚úÖ Semaine r√©initialis√©e');
}

function resetTout() {
    if (!confirm('üóëÔ∏è ATTENTION : Effacer TOUTES les donn√©es ?')) return;
    if (!confirm('‚ö†Ô∏è DERNI√àRE CONFIRMATION\n\nVous allez perdre 100% de vos donn√©es.\n\nContinuer ?')) return;
    
    const keysToRemove = [];
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('repas-') || key === 'grignotages' || key === 'pesees-hebdo' || key === 'jourType' || key === 'options-repas') {
            keysToRemove.push(key);
        }
    }
    
    keysToRemove.forEach(key => localStorage.removeItem(key));
    
    location.reload();
}

function telechargerBackup() {
    const backup = {
        version: '5.0-seche-10sem',
        dateExport: new Date().toISOString(),
        dateDebut: PLAN_HYBRIDE.dateDebut,
        poidsInitial: PLAN_HYBRIDE.poidsInitial,
        tailleInitiale: PLAN_HYBRIDE.tailleInitiale,
        semaineActuelle: semaineActuelle,
        jourType: jourType,
        repasValidations: {},
        grignotages: grignotages,
        pesees: pesees,
        optionsSelectionnees: optionsSelectionnees
    };
    
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('repas-')) {
            const date = key.replace('repas-', '');
            backup.repasValidations[date] = JSON.parse(localStorage.getItem(key));
        }
    }
    
    const nbJours = Object.keys(backup.repasValidations).length;
    const nbPesees = backup.pesees.length;
    const nbGrignotages = backup.grignotages.length;
    
    backup.stats = {nbJours, nbPesees, nbGrignotages};
    
    const jsonString = JSON.stringify(backup, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `backup-seche-10sem-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    localStorage.setItem('last-backup', new Date().toISOString());
    updateLastBackupDate();
    
    alert(`‚úÖ Backup t√©l√©charg√© !\n\nüìä Contenu :\n- ${nbJours} jours de donn√©es\n- ${nbPesees} pes√©es\n- ${nbGrignotages} grignotages`);
}

function restaurerBackup(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    if (!confirm('üì• Restaurer ce backup ?\n\n‚ö†Ô∏è Cela va REMPLACER toutes tes donn√©es actuelles !')) {
        event.target.value = '';
        return;
    }
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const backup = JSON.parse(e.target.result);
            
            PLAN_HYBRIDE.dateDebut = backup.dateDebut;
            PLAN_HYBRIDE.poidsInitial = backup.poidsInitial;
            PLAN_HYBRIDE.tailleInitiale = backup.tailleInitiale;
            
            Object.entries(backup.repasValidations).forEach(([date, validations]) => {
                localStorage.setItem(`repas-${date}`, JSON.stringify(validations));
            });
            
            grignotages = backup.grignotages || [];
            localStorage.setItem('grignotages', JSON.stringify(grignotages));
            
            pesees = backup.pesees || [];
            localStorage.setItem('pesees-hebdo', JSON.stringify(pesees));
            
            if (backup.optionsSelectionnees) {
                optionsSelectionnees = backup.optionsSelectionnees;
                localStorage.setItem('options-repas', JSON.stringify(optionsSelectionnees));
            }
            
            if (backup.jourType) {
                jourType = backup.jourType;
                localStorage.setItem('jourType', jourType);
            }
            
            alert(`‚úÖ Backup restaur√© !\n\nüìä Donn√©es import√©es :\n- ${backup.stats?.nbJours || 0} jours\n- ${backup.stats?.nbPesees || 0} pes√©es\n- ${backup.stats?.nbGrignotages || 0} grignotages`);
            
            location.reload();
            
        } catch (error) {
            alert('‚ùå Erreur lors de la restauration !');
        }
    };
    
    reader.readAsText(file);
    event.target.value = '';
}

function updateLastBackupDate() {
    const lastBackup = localStorage.getItem('last-backup');
    if (lastBackup) {
        const date = new Date(lastBackup);
        const formatted = date.toLocaleDateString('fr-FR') + ' √† ' + date.toLocaleTimeString('fr-FR', {hour: '2-digit', minute: '2-digit'});
        document.getElementById('last-backup-date').textContent = formatted;
    }
}

window.addEventListener('load', updateLastBackupDate);

function showAutoSave() {
    const indicator = document.getElementById('auto-save-indicator');
    indicator.classList.add('show');
    setTimeout(() => indicator.classList.remove('show'), 2000);
}

function showTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById('tab-' + tabName).classList.add('active');
    event.target.classList.add('active');
    
    if (tabName === 'suivi10sem') {
        afficherCarteSemaine();
        afficherGraphiquePoids();
        afficherHistoriquePesees();
        afficherAlertes();
    }
    if (tabName === 'saison') afficherSaison();
}
    </script>
</body>
</html>
